<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Nos.S¬∞lar ‚Äî Stack Solar Din√¢mica</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- üî• Cabe√ßalho PWA / Manifest / √çcones -->
<link rel="manifest" href="manifest.webmanifest">

<link rel="apple-touch-icon" sizes="180x180" href="icons/icon-192.png">
<link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="icons/icon-512.png">

<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

<style>
/* MOBILE-FIRST VERTICAL HARD-LOCK */

/* Tokens Nebula Pro Solar */
:root {
  --bg-day: radial-gradient(circle at 20% 10%, #fff9c4 0%, #ffe082 35%, #ffb74d 70%, #ff9800 100%);
  --bg-sunset: radial-gradient(circle at 10% 0%, #ffd180 0%, #ff8a65 30%, #f06292 60%, #7e57c2 100%);
  --bg-night: radial-gradient(circle at 20% 0%, #0b1020 0%, #121c3b 40%, #1a237e 80%, #000000 100%);

  --panel: #050d18cc;
  --ink: #eafcff;
  --muted: #9fb3cc;

  --accent: #7dd3fc;
  --accent-soft: rgba(125, 211, 252, 0.18);

  --sun-scale: 1;
}

*,
*::before,
*::after {
  box-sizing: border-box;
}

html, body {
  margin: 0;
  padding: 0;
}

body {
  min-height: 100vh;
  font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  color: var(--ink);
  display: flex;
  flex-direction: column;
  align-items: stretch;
  justify-content: flex-start;
  background: var(--bg-day);
  transition: background 4s ease-in-out;
  overflow-x: hidden;
}

/* SPLASH / LOADER NOS.S¬∞LAR (SplashFake v2 style) */
#splash-nosolar {
  position: fixed;
  inset: 0;
  z-index: 50;
  background: radial-gradient(circle at 20% 0%, #ffe082 0%, #ffb74d 20%, #ff7043 45%, #311b92 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  pointer-events: auto;
  transition: opacity 0.7s ease, transform 0.7s ease;
}

#splash-nosolar.hide {
  opacity: 0;
  transform: scale(1.02);
  pointer-events: none;
}

.splash-inner {
  text-align: center;
  color: #fffde7;
}

.splash-circle {
  width: 120px;
  height: 120px;
  border-radius: 999px;
  border: 2px solid rgba(255, 255, 255, 0.35);
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 14px;
  box-shadow:
    0 0 40px rgba(255, 241, 118, 0.9),
    0 0 0 1px rgba(255, 255, 255, 0.15);
  position: relative;
  overflow: hidden;
  background: radial-gradient(circle at 50% 40%, #fffde7 0%, #ffca28 40%, #f57c00 80%);
}

.splash-circle::after {
  content: "";
  position: absolute;
  bottom: -10%;
  left: 50%;
  width: 140%;
  height: 70%;
  transform: translateX(-50%);
  background: radial-gradient(circle at 50% 120%, rgba(0,0,0,0.7) 0%, transparent 70%);
  opacity: 0.65;
}

.splash-portal {
  width: 46px;
  height: 68px;
  border-radius: 46px 46px 20px 20px;
  border: 2px solid rgba(33, 33, 33, 0.9);
  background: radial-gradient(circle at 50% 0%, #fff9c4 0%, #ffb74d 35%, #4a148c 100%);
  box-shadow:
    0 0 18px rgba(255, 241, 118, 0.9),
    0 0 0 1px rgba(255, 255, 255, 0.4);
  position: relative;
  overflow: hidden;
}

.splash-portal::before {
  content: "";
  position: absolute;
  inset: 18% 22%;
  border-radius: 999px;
  border: 1px solid rgba(255, 255, 255, 0.8);
  box-shadow: 0 0 14px rgba(255, 255, 255, 0.7);
}

.splash-text {
  font-size: 1.1rem;
  font-weight: 800;
  letter-spacing: 0.08em;
  text-transform: uppercase;
}

.splash-sub {
  margin-top: 6px;
  font-size: 0.82rem;
  opacity: 0.9;
}

/* Loader operacional (aparece se demorar > 600ms) */
#nv-loader {
  position: fixed;
  inset: 0;
  z-index: 40;
  background: radial-gradient(circle at 20% 0%, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.35));
  display: flex;
  align-items: flex-end;
  justify-content: center;
  padding-bottom: 32px;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.3s ease;
}

#nv-loader.visible {
  opacity: 1;
  pointer-events: auto;
}

.nv-loader-inner {
  display: inline-flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  padding: 8px 14px;
  border-radius: 999px;
  background: rgba(15, 23, 42, 0.95);
  border: 1px solid rgba(148, 163, 184, 0.6);
  box-shadow: 0 16px 40px rgba(0, 0, 0, 0.7);
  color: #e5e7eb;
  font-size: 0.78rem;
}

.nv-loader-orbit {
  width: 20px;
  height: 20px;
  border-radius: 999px;
  border: 2px solid rgba(148, 163, 184, 0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
}

.nv-loader-dot {
  position: absolute;
  width: 6px;
  height: 6px;
  border-radius: 999px;
  background: #facc15;
  box-shadow: 0 0 8px rgba(250, 204, 21, 0.9);
  animation: loader-orbit 1.1s linear infinite;
}

/* Camada de c√©u e part√≠culas */
.sky-layer {
  position: fixed;
  inset: 0;
  overflow: hidden;
  z-index: 0;
  pointer-events: none;
}

.sun {
  position: absolute;
  width: 160px;
  height: 160px;
  border-radius: 50%;
  background: radial-gradient(circle at 30% 30%, #fffde7 0%, #fff176 40%, #ffb300 100%);
  filter: blur(0.5px);
  opacity: 0.9;
  animation: sun-orbit 24s linear infinite;
  box-shadow: 0 0 60px rgba(255, 236, 179, 0.85);
}

.particle {
  position: absolute;
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.8);
  box-shadow: 0 0 12px rgba(255, 255, 255, 0.9);
  opacity: 0.8;
  animation: float-particle 14s linear infinite;
}

.p1 { left: 10%; top: 70%; animation-delay: -2s; }
.p2 { left: 30%; top: 80%; animation-delay: -6s; }
.p3 { left: 55%; top: 65%; animation-delay: -10s;}
.p4 { left: 75%; top: 85%; animation-delay: -4s; }
.p5 { left: 90%; top: 75%; animation-delay: -8s; }

/* Shell principal */
.app-shell {
  position: relative;
  z-index: 1;
  padding: 18px 12px 24px;
  display: flex;
  flex-direction: column;
  align-items: stretch;
  gap: 16px;
}

/* Header */
.app-header {
  text-align: center;
}

.tag-solar {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-size: 0.82rem;
  padding: 4px 9px;
  border-radius: 999px;
  background: rgba(255, 235, 59, 0.08);
  border: 1px solid rgba(255, 235, 59, 0.45);
  color: #fffde7;
}

.app-title {
  font-size: 1.4rem;
  font-weight: 800;
  letter-spacing: 0.04em;
  text-transform: uppercase;
  text-shadow: 0 0 18px rgba(0, 0, 0, 0.6);
  margin: 6px 0 4px;
}

.app-subtitle {
  font-size: 0.85rem;
  color: var(--muted);
}

/* STACK DE CARDS (SANFONA) */
.card-stack {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

/* Card / Sanfona ‚Äì CSS refinado v3 */
.card {
  background: var(--panel);
  border-radius: 14px;
  backdrop-filter: blur(12px);
  box-shadow:
    0 18px 40px rgba(0, 0, 0, 0.45),
    0 0 0 1px rgba(255, 255, 255, 0.03);
  overflow: hidden;
}

/* Header de card estilo Markdown visual */
.card-header {
  padding: 14px 14px;
  display: flex;
  flex-direction: row;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
}

.card-title {
  font-size: 0.98rem;
  font-weight: 600;
}

.card-header small {
  font-size: 0.78rem;
  color: var(--muted);
}

.card-toggle {
  font-size: 1.1rem;
  opacity: 0.7;
}

/* Corpo dos cards */
.card-body {
  max-height: 0;
  overflow: auto;
  -webkit-overflow-scrolling: touch;
  padding: 0 14px;
  transition:
    max-height 0.4s ease,
    padding-top 0.3s ease,
    padding-bottom 0.3s ease;
}

.card-body-inner {
  padding: 8px 0 14px;
  line-height: 1.5;
}

/* BLOCO ESTILO MARKDOWN */
.card-body-inner p:first-of-type {
  position: relative;
  margin: 0 0 8px;
  padding-left: 10px;
  font-size: 0.9rem;
  color: var(--muted);
}

.card-body-inner p:first-of-type::before {
  content: "#";
  position: absolute;
  left: -2px;
  top: 0;
  font-size: 0.78rem;
  color: var(--accent);
  opacity: 0.9;
}

/* Par√°grafos seguintes */
.card-body-inner p + p {
  margin-top: 4px;
  font-size: 0.88rem;
}

/* Tagzinha tipo ::info */
.md-tag {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  padding: 2px 8px;
  border-radius: 999px;
  background: rgba(15, 23, 42, 0.9);
  border: 1px solid rgba(148, 163, 184, 0.5);
  color: #e5e7eb;
}

/* Linha de bot√µes */
.btn-row {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-top: 8px;
}

.btn {
  display: inline-flex;
  width: 100%;
  justify-content: center;
  align-items: center;
  padding: 10px 14px;
  border-radius: 999px;
  border: none;
  background: rgba(255, 255, 255, 0.16);
  color: var(--ink);
  font-size: 0.92rem;
  font-weight: 600;
  letter-spacing: 0.02em;
  cursor: pointer;
  backdrop-filter: blur(6px);
  transition:
    background 0.3s ease,
    transform 0.2s ease,
    box-shadow 0.3s ease;
}

.btn span {
  margin-left: 6px;
}

.btn:active {
  transform: scale(0.97);
}

.btn:hover {
  background: rgba(255, 255, 255, 0.26);
  box-shadow: 0 0 22px rgba(255, 255, 255, 0.18);
}

/* Indicadores */
.mode-indicator,
.geo-indicator,
.tips-indicator {
  margin-top: 8px;
  font-size: 0.8rem;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  color: var(--muted);
}

/* Ondas sonoras visuais */
.wave-container {
  position: relative;
  margin-top: 10px;
  height: 40px;
  overflow: hidden;
}

.wave {
  position: absolute;
  inset: 0;
  background: repeating-linear-gradient(
    to right,
    rgba(144, 202, 249, 0.2) 0,
    rgba(144, 202, 249, 0.8) 2px,
    transparent 4px
  );
  opacity: 0.7;
  transform-origin: left center;
  animation: wave-move 3s linear infinite;
}

.wave.wave2 {
  opacity: 0.4;
  animation-duration: 5s;
}

/* √Årea do template do Livro Vivo */
#nv-template-output {
  width: 100%;
  min-height: 120px;
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.12);
  background: rgba(2,6,23,0.7);
  color: var(--ink);
  padding: 8px 10px;
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-size: 0.85rem;
  resize: vertical;
}

/* Resultado LS */
#nv-ls-output {
  width: 100%;
  min-height: 80px;
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.12);
  background: rgba(2,6,23,0.7);
  color: var(--ink);
  padding: 8px 10px;
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-size: 0.8rem;
  white-space: pre-wrap;
}

/* Card de m√©tricas de ambiente */
.env-metrics {
  margin-top: 10px;
}

.env-card {
  border-radius: 14px;
  padding: 10px 12px;
  background: rgba(15, 23, 42, 0.96);
  border: 1px solid rgba(148, 163, 184, 0.6);
  box-shadow:
    0 16px 38px rgba(0, 0, 0, 0.75),
    0 0 0 1px rgba(15, 23, 42, 0.8);
}

.env-card h4 {
  margin: 0 0 6px;
  font-size: 0.9rem;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: #e5e7eb;
}

.env-card small {
  display: block;
  margin-bottom: 8px;
  font-size: 0.72rem;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 0.16em;
}

.env-grid {
  display: flex;
  flex-direction: column;
  gap: 4px;
  font-size: 0.82rem;
}

.env-row {
  display: flex;
  justify-content: space-between;
  gap: 8px;
}

.env-label {
  color: var(--muted);
}

.env-value {
  font-weight: 600;
}

/* Blocos de dicas estilo InfoDocs */
.tip-block {
  margin-top: 6px;
  padding: 8px 10px;
  border-radius: 10px;
  background: rgba(15, 23, 42, 0.9);
  border: 1px solid rgba(148, 163, 184, 0.5);
  display: flex;
  flex-direction: column;
  gap: 2px;
  font-size: 0.82rem;
}
.tip-block strong {
  font-size: 0.84rem;
}

/* Modos de fundo & sol/lua */
body.mode-day {
  background: var(--bg-day);
  --sun-scale: 1;
}

body.mode-sunset {
  background: var(--bg-sunset);
  --sun-scale: 0.9;
}

body.mode-night {
  background: var(--bg-night);
  --sun-scale: 0.65;
}

body.mode-day .sun,
body.mode-sunset .sun {
  background: radial-gradient(circle at 30% 30%, #fffde7 0%, #fff176 40%, #ffb300 100%);
  box-shadow: 0 0 60px rgba(255, 236, 179, 0.85);
}

body.mode-night .sun {
  background: radial-gradient(circle at 30% 30%, #e8f5ff 0%, #bbdefb 45%, #90caf9 100%);
  box-shadow: 0 0 40px rgba(187, 222, 251, 0.85);
}

/* Campo gal√°ctico baseado em lat/long */
#galaxy-field {
  position: fixed;
  inset: 0;
  z-index: 0;
  pointer-events: none;
  overflow: hidden;
  opacity: 0;
  transition: opacity .6s ease;
}

.star {
  position: absolute;
  width: 3px;
  height: 3px;
  background: white;
  border-radius: 999px;
  opacity: .8;
  filter: drop-shadow(0 0 6px white);
  animation: star-float 14s linear infinite;
}

#galaxy-info {
  position: fixed;
  bottom: 18px;
  left: 0;
  right: 0;
  margin: auto;
  width: calc(100% - 24px);
  max-width: 360px;
  padding: 10px 14px;
  border-radius: 14px;
  background: rgba(0,0,0,0.55);
  color: #d0e7ff;
  font-size: .8rem;
  text-align: center;
  backdrop-filter: blur(8px);
  opacity: 0;
  transform: translateY(20px);
  transition: all .6s ease;
  z-index: 2;
}
#galaxy-info.show {
  opacity: 1;
  transform: translateY(0);
}

/* Toast */
#nv-toast {
  position: fixed;
  bottom: 22px;
  left: 50%;
  transform: translateX(-50%) translateY(40px);
  background: rgba(0,0,0,0.7);
  color: #fff;
  padding: 10px 16px;
  border-radius: 12px;
  backdrop-filter: blur(10px);
  font-size: .85rem;
  opacity: 0;
  transition: all .4s ease;
  z-index: 9999;
}
#nv-toast.show {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}

/* Anima√ß√µes */
@keyframes sun-orbit {
  0% {
    transform: translate(-20%, 10%) scale(var(--sun-scale));
  }
  25% {
    transform: translate(40%, -10%) scale(var(--sun-scale));
  }
  50% {
    transform: translate(80%, 15%) scale(var(--sun-scale));
  }
  75% {
    transform: translate(40%, 35%) scale(var(--sun-scale));
  }
  100% {
    transform: translate(-20%, 10%) scale(var(--sun-scale));
  }
}

@keyframes float-particle {
  0% {
    transform: translateY(0px) scale(1);
    opacity: 0.2;
  }
  20% {
    opacity: 0.8;
  }
  50% {
    transform: translateY(-40px) scale(1.2);
  }
  80% {
    opacity: 0.4;
  }
  100% {
    transform: translateY(-80px) scale(0.9);
    opacity: 0;
  }
}

@keyframes wave-move {
  0% { transform: translateX(0) skewX(-8deg); }
  100% { transform: translateX(-40px) skewX(-8deg); }
}

@keyframes loader-orbit {
  0% { transform: rotate(0deg) translateX(7px) rotate(0deg); }
  100% { transform: rotate(360deg) translateX(7px) rotate(-360deg); }
}

@keyframes star-float {
  0% { transform: translateY(0px); }
  100% { transform: translateY(-120px); opacity: 0; }
}

/* Responsive */
@media (min-height: 780px) {
  .app-shell {
    padding-top: 26px;
  }
}

  /* ===== BG FAKE UNIVERSAL ‚Äì overlay simb√≥lico ===== */

body.bg-fake{
  position: relative;
  overflow-x: hidden;
}

/* Camada falsa por cima do BG real */
body.bg-fake::before{
  content: "";
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: -1;

  /* imagem vem de uma CSS var pra poder trocar s√≥ no HTML */
  background:
    var(--bg-fake-img, url("icons/icon-traco-512.PNG"))
    center center /
    cover no-repeat;

  /* tipo de mistura: teste lighten, screen, multiply‚Ä¶ */
  mix-blend-mode: var(--bg-fake-mode, overlay);
  opacity: var(--bg-fake-opacity, .78);
}

/* opcional: glow suave */
/* body.bg-fake::after{
  content: "";
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: -2;
  background:
    radial-gradient(circle at center,
      rgba(255,255,255,.16) 0,
      transparent 55%);
  mix-blend-mode: soft-light;
  opacity: .6;
} */
</style>
</head>
<body class="mode-day">
  <!-- SplashFake / holar -->
  <div id="splash-nosolar">
    <div class="splash-inner">
      <div class="splash-circle">
        <div class="splash-portal"></div>
      </div>
      <div class="splash-text">Nos.S¬∞lar ‚Äî dual.infodose</div>
      <div class="splash-sub">(carregando o holar & o p√¥r do sol na oca...)</div>
    </div>
  </div>

  <!-- Loader operacional -->
  <div id="nv-loader">
    <div class="nv-loader-inner">
      <div class="nv-loader-orbit">
        <div class="nv-loader-dot"></div>
      </div>
      <span>Sincronizando Nos.S¬∞lar‚Ä¶</span>
    </div>
  </div>

  <div class="sky-layer">
    <div class="sun"></div>
    <div class="particle p1"></div>
    <div class="particle p2"></div>
    <div class="particle p3"></div>
    <div class="particle p4"></div>
    <div class="particle p5"></div>
  </div>

  <!-- Campo gal√°ctico + info -->
  <div id="galaxy-field"></div>
  <div id="galaxy-info"></div>

  <div class="app-shell">
    <header class="app-header">
      <div class="tag-solar">
        ‚òÄÔ∏è <span>Nos.S¬∞lar ¬∑ Rede Solar Simb√≥lica</span>
      </div>
      <h1 class="app-title">Stack Solar Din√¢mica</h1>
      <p class="app-subtitle">
        Dia ‚Üí P√¥r do Sol ‚Üí Noite ¬∑ Estado solar local ¬∑ Dicas Meta-Humano-M√°quina ¬∑ Livro Vivo
      </p>
    </header>

    <main class="card-stack">

      <!-- CARD 0: Boas-vindas / Livro Vivo / Gerador + TTS -->
      <section class="card" data-card="welcome">
        <div class="card-header" onclick="toggleCard(this)">
          <div>
            <div class="card-title">Boas-vindas ¬∑ Livro Vivo & InfoDocs</div>
            <small>(gerador ¬∑ TTS ¬∑ ponte com o Hub)</small>
          </div>
          <div class="card-toggle">‚åÑ</div>
        </div>
        <div class="card-body">
          <div class="card-body-inner">
            <p>
              <span class="md-tag">::info</span>
              Este card √© a porta de entrada do <strong>Nos.S¬∞lar</strong> com o
              <strong>Livro Vivo / InfoDocs</strong>: aqui voc√™ gera templates de documentos,
              testa voz (TTS) e copia o conte√∫do direto para o Hub principal.
            </p>

            <div class="btn-row">
              <button class="btn" onclick="nvGenerateTemplate('basico'); event.stopPropagation();">
                ‚ú®<span>Gerar template ‚Äî Documento Solar B√°sico</span>
              </button>
              <button class="btn" onclick="nvGenerateTemplate('escola'); event.stopPropagation();">
                üè´<span>Gerar template ‚Äî Educa√ß√£o Solar em Escolas</span>
              </button>
              <button class="btn" onclick="nvGenerateTemplate('parque'); event.stopPropagation();">
                üè≠<span>Gerar template ‚Äî Parque Tecnol√≥gico & Micro Data Center</span>
              </button>
              <button class="btn" onclick="nvSpeakWelcome(); event.stopPropagation();">
                üîä<span>Ouvir boas-vindas (TTS)</span>
              </button>
            </div>

            <p style="font-size:0.8rem;color:var(--muted);margin-top:8px;">
              Copie o conte√∫do abaixo e cole no painel principal do InfoDocs / Livro Vivo para
              continuar a edi√ß√£o completa.
            </p>

            <textarea id="nv-template-output" placeholder="# Seu template Livro Vivo aparecer√° aqui..."></textarea>
          </div>
        </div>
      </section>

      <!-- CARD 0.5: LS Status interno do Nos.S¬∞lar -->
      <section class="card" data-card="ls">
        <div class="card-header" onclick="toggleCard(this)">
          <div>
            <div class="card-title">LocalStorage ¬∑ Estado interno do Nos.S¬∞lar</div>
            <small>(debug leve ¬∑ chaves ¬∑ espa√ßo)</small>
          </div>
          <div class="card-toggle">‚åÑ</div>
        </div>
        <div class="card-body">
          <div class="card-body-inner">
            <p>
              <span class="md-tag">::ls</span>
              Leitura simb√≥lica do <strong>localStorage</strong> deste micro-app:
              quantas chaves existem, quais s√£o e quanto espa√ßo aproximado ocupam.
            </p>

            <div class="btn-row">
              <button class="btn" onclick="nvLsScan(); event.stopPropagation();">
                üîç<span>Ver estado atual do LS</span>
              </button>
              <button class="btn" onclick="nvLsClear(); event.stopPropagation();">
                üßπ<span>Limpar chaves do Nos.S¬∞lar</span>
              </button>
            </div>

            <p style="font-size:0.8rem;color:var(--muted);margin-top:8px;">
              Este card √© o ‚Äúespelho local‚Äù do armazenamento: perfeito para debug leve sem
              abrir o painel LS_STATUS completo.
            </p>

            <div id="nv-ls-output" aria-label="Sa√≠da de LocalStorage"></div>
          </div>
        </div>
      </section>

      <!-- CARD 1: CICLO SOLAR -->
      <section class="card" data-card="solar">
        <div class="card-header" onclick="toggleCard(this)">
          <div>
            <div class="card-title">Painel Solar Din√¢mico</div>
            <small>(dia ¬∑ p√¥r do sol ¬∑ noite)</small>
          </div>
          <div class="card-toggle">‚åÑ</div>
        </div>
        <div class="card-body">
          <div class="card-body-inner">
            <p>
              <span class="md-tag">::ciclo</span>
              Controle visual do ciclo solar: de <strong>capta√ß√£o m√°xima</strong> √†
              <strong>rede de dados iluminada</strong>.
            </p>
            <div class="btn-row">
              <button class="btn" onclick="setMode('day'); event.stopPropagation();">
                ‚òÄÔ∏è<span>Dia ‚Äî Capta√ß√£o Solar M√°xima</span>
              </button>
              <button class="btn" onclick="setMode('sunset'); event.stopPropagation();">
                üåá<span>P√¥r do Sol ‚Äî Transi√ß√£o Energia ‚Üí Dados</span>
              </button>
              <button class="btn" onclick="setMode('night'); event.stopPropagation();">
                üåô<span>Noite ‚Äî Lua ¬∑ Rede de Dados Ativa</span>
              </button>
            </div>
            <div class="mode-indicator" id="modeIndicator">
              MODO ATUAL: DIA ¬∑ CAPTA√á√ÉO & CARREGAMENTO
            </div>
          </div>
        </div>
      </section>

      <!-- CARD 2: LOCALIZA√á√ÉO & ONDAS SONORAS (binaural + arpejo) -->
      <section class="card" data-card="geo">
        <div class="card-header" onclick="toggleCard(this)">
          <div>
            <div class="card-title">Painel Sonoro ¬∑ Estado Solar Local</div>
            <small>(lat/long simb√≥licas + ondas g√™meas)</small>
          </div>
          <div class="card-toggle">‚åÑ</div>
        </div>
        <div class="card-body">
          <div class="card-body-inner">
            <p>
              <span class="md-tag">::geo</span>
              Detecta sua posi√ß√£o na Terra, exibe <strong>lat/long simb√≥licas</strong> e
              ativa duas ondas sonoras que dan√ßam com o seu estado solar (binaural simb√≥lico),
              com op√ß√£o de arpejo harm√¥nico ligado √† latitude.
            </p>
            <div class="btn-row">
              <button class="btn" onclick="pedirLocalizacao(event)">
                üìç<span>Descobrir minha posi√ß√£o solar</span>
              </button>
              <button class="btn" onclick="toggleOndas(event)">
                üîä<span>Tocar / Pausar binaural detectado</span>
              </button>
              <button class="btn" onclick="tocarArpejo(event)">
                üéº<span>Ativar / Pausar arpejo harm√¥nico</span>
              </button>
            </div>
            <div class="geo-indicator" id="geoIndicator">
              LOCALIZA√á√ÉO: Aguardando permiss√£o...
            </div>

            <div class="wave-container">
              <div class="wave"></div>
              <div class="wave wave2"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- CARD 3: DICAS META-HUMANO-M√ÅQUINA -->
      <section class="card" data-card="tips">
        <div class="card-header" onclick="toggleCard(this)">
          <div>
            <div class="card-title">Painel de Dicas ¬∑ Meta-Humano-M√°quina</div>
            <small>(manh√£ ¬∑ tarde ¬∑ noite)</small>
          </div>
          <div class="card-toggle">‚åÑ</div>
        </div>
        <div class="card-body">
          <div class="card-body-inner">
            <p>
              <span class="md-tag">::dicas</span>
              Gera tr√™s dicas: <strong>manh√£, tarde e noite</strong>, correlacionando o
              seu corpo com o corpo simbi√≥tico da rede Nos.S¬∞lar.
            </p>
            <div class="btn-row">
              <button class="btn" onclick="gerarDicas(event)">
                üí´<span>Gerar dicas para hoje</span>
              </button>
            </div>
            <div class="tips-indicator" id="tipsIndicator">
              DICAS: Toque para gerar o ciclo de hoje.
            </div>

            <div id="tipsContainer">
              <!-- Dicas aparecem aqui -->
            </div>
          </div>
        </div>
      </section>

      <!-- CARD 4: An√°lise de Ambiente (com loader + m√©tricas) -->
      <section class="card" data-card="env">
        <div class="card-header" onclick="toggleCard(this)">
          <div>
            <div class="card-title">Analisar meu ambiente solar</div>
            <small>(hora ¬∑ modo ¬∑ geo ¬∑ recomenda√ß√£o)</small>
          </div>
          <div class="card-toggle">‚åÑ</div>
        </div>
        <div class="card-body">
          <div class="card-body-inner">
            <p>
              <span class="md-tag">::ambiente</span>
              Faz uma leitura simb√≥lica r√°pida do seu ambiente: hor√°rio, ciclo solar atual,
              latitude/longitude base e uma recomenda√ß√£o de ajuste de rotina.
            </p>
            <div class="btn-row">
              <button class="btn" onclick="nvAnalyzeEnv(event)">
                üìä<span>Analisar meu ambiente agora</span>
              </button>
            </div>
            <div class="env-metrics" id="envMetrics">
              <!-- Card de m√©tricas aparece aqui -->
            </div>
          </div>
        </div>
      </section>

    </main>
  </div>

  <!-- Toast -->
  <div id="nv-toast"></div>

<script>
/* SPLASH HANDLER */
window.addEventListener('load', function() {
  var splash = document.getElementById('splash-nosolar');
  if (!splash) return;
  setTimeout(function() {
    splash.classList.add('hide');
    setTimeout(function() {
      splash.style.display = 'none';
    }, 900);
  }, 900);
});

/* LOADER >600ms */
let nvLoaderTimer = null;
function nvStartLoading() {
  const el = document.getElementById('nv-loader');
  if (!el) return;
  if (nvLoaderTimer) clearTimeout(nvLoaderTimer);
  nvLoaderTimer = setTimeout(function() {
    el.classList.add('visible');
  }, 600);
}
function nvStopLoading() {
  const el = document.getElementById('nv-loader');
  if (!el) return;
  if (nvLoaderTimer) {
    clearTimeout(nvLoaderTimer);
    nvLoaderTimer = null;
  }
  el.classList.remove('visible');
}

/* SANFONA DE CARDS */
function toggleCard(headerEl) {
  var card = headerEl.closest('.card');
  var body = card.querySelector('.card-body');
  var toggleIcon = card.querySelector('.card-toggle');

  var isOpen = card.classList.contains('open');
  if (isOpen) {
    card.classList.remove('open');
    body.style.maxHeight = '0px';
    toggleIcon.textContent = '‚åÑ';
  } else {
    card.classList.add('open');
    body.style.maxHeight = body.scrollHeight + 'px';
    toggleIcon.textContent = '‚åÉ';
  }
}

/* Ajusta maxHeight ao redimensionar */
window.addEventListener('resize', function() {
  document.querySelectorAll('.card.open .card-body').forEach(function(body) {
    body.style.maxHeight = body.scrollHeight + 'px';
  });
});

/* CICLO SOLAR */
function setMode(mode) {
  document.body.classList.remove('mode-day', 'mode-sunset', 'mode-night');
  var indicator = document.getElementById('modeIndicator');

  if (mode === 'day') {
    document.body.classList.add('mode-day');
    indicator.textContent = 'MODO ATUAL: DIA ¬∑ CAPTA√á√ÉO & CARREGAMENTO';
  } else if (mode === 'sunset') {
    document.body.classList.add('mode-sunset');
    indicator.textContent = 'MODO ATUAL: P√îR DO SOL ¬∑ TRANSI√á√ÉO ENERGIA ‚Üí DADOS';
  } else if (mode === 'night') {
    document.body.classList.add('mode-night');
    indicator.textContent =
      'MODO ATUAL: NOITE ¬∑ LUA MENOR ¬∑ REDE DE DADOS ILUMINADA PELA ENERGIA DO DIA';
  }
}

/* Helper para label do modo atual */
function nvGetSolarModeLabel() {
  if (document.body.classList.contains('mode-night')) return 'NOITE ¬∑ REDE DE DADOS';
  if (document.body.classList.contains('mode-sunset')) return 'P√îR DO SOL ¬∑ TRANSI√á√ÉO';
  return 'DIA ¬∑ CAPTA√á√ÉO & CARGA';
}

/* Tema autom√°tico baseado no hor√°rio do usu√°rio */
function nvAutoTheme() {
  const h = new Date().getHours();
  if (h >= 19 || h < 6) {
    setMode('night');
    nvToast('Modo solar ajustado automaticamente para NOITE.');
  } else if (h >= 16) {
    setMode('sunset');
    nvToast('Modo solar ajustado automaticamente para P√îR DO SOL.');
  } else {
    setMode('day');
    nvToast('Modo solar ajustado automaticamente para DIA.');
  }
}
window.addEventListener('load', nvAutoTheme);

/* GEO + ONDAS SONORAS (Web Audio / binaural) */
let geoLat = null;
let geoLng = null;
let audioCtx = null;
let osc1 = null;
let osc2 = null;
let ondasAtivas = false;
let arpOsc = null;

/* TOAST */
function nvToast(msg) {
  const t = document.getElementById('nv-toast');
  if (!t) return;
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2400);
}

function pedirLocalizacao(ev) {
  ev.stopPropagation();
  nvStartLoading();
  const indicator = document.getElementById('geoIndicator');
  const galaxy = document.getElementById('galaxy-field');
  const galaxyInfo = document.getElementById('galaxy-info');

  if (!navigator.geolocation) {
    indicator.textContent = 'LOCALIZA√á√ÉO: navegador n√£o suporta.';
    nvStopLoading();
    nvToast('Navegador n√£o suporta geolocaliza√ß√£o.');
    return;
  }

  indicator.textContent = 'LOCALIZA√á√ÉO: pedindo permiss√£o...';

  navigator.geolocation.getCurrentPosition(pos => {
    geoLat = pos.coords.latitude;
    geoLng = pos.coords.longitude;

    indicator.textContent =
      'LOCALIZA√á√ÉO: ' +
      geoLat.toFixed(4) + ' ¬∑ ' +
      geoLng.toFixed(4) +
      ' ‚Äî estado gal√°ctico detectado';

    // üåü ATIVA anima√ß√£o gal√°ctica
    if (galaxy) {
      galaxy.innerHTML = '';
      for (let i = 0; i < 80; i++) {
        const s = document.createElement('div');
        s.className = 'star';
        s.style.left = Math.random()*100 + '%';
        s.style.top = (100 + Math.random()*50) + '%';
        s.style.animationDelay = (Math.random()*-12) + 's';
        galaxy.appendChild(s);
      }
      galaxy.style.opacity = 1;
    }

    // üåû PER√çODO DO ANO / ESTA√á√ÉO SIMB√ìLICA
    const now = new Date();
    const start = new Date(now.getFullYear(), 0, 0);
    const diff = now - start;
    const oneDay = 1000 * 60 * 60 * 24;
    const dayOfYear = Math.floor(diff / oneDay);
    const m = now.getMonth(); // 0-11

    let estacao = 'transi√ß√£o';
    // Hemisf√©rio Sul simb√≥lico
    if (m === 11 || m <= 1) estacao = 'VER√ÉO simb√≥lico';
    else if (m >= 2 && m <= 4) estacao = 'OUTONO simb√≥lico';
    else if (m >= 5 && m <= 7) estacao = 'INVERNO simb√≥lico';
    else estacao = 'PRIMAVERA simb√≥lica';

    if (galaxyInfo) {
      galaxyInfo.textContent =
        'Dia ' + dayOfYear + ' do ano ¬∑ ' +
        estacao + ' ¬∑ Lat ' + geoLat.toFixed(2) +
        ' ¬∑ Lng ' + geoLng.toFixed(2);
      galaxyInfo.classList.add('show');
    }

    nvStopLoading();
    nvToast('Posi√ß√£o solar detectada com sucesso.');

  }, err => {
    indicator.textContent = 'LOCALIZA√á√ÉO: negada.';
    nvStopLoading();
    nvToast('Permiss√£o de localiza√ß√£o negada.');
  }, {
    enableHighAccuracy: false,
    timeout: 8000,
    maximumAge: 60000
  });
}

/* Garante que o AudioContext esteja ‚Äúresumed‚Äù (iOS / mobile) */
function nvEnsureAudioCtx() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  if (audioCtx.state === 'suspended') {
    return audioCtx.resume();
  }
  return Promise.resolve();
}

/* Binaural detectado ‚Äì com loader e fix */
async function toggleOndas(ev) {
  ev.stopPropagation();
  nvStartLoading();
  var indicator = document.getElementById('geoIndicator');

  try {
    await nvEnsureAudioCtx();

    if (!ondasAtivas) {
      // base binaural simb√≥lica
      let baseLat = geoLat != null ? Math.abs(geoLat) : 23.5;
      let baseLng = geoLng != null ? Math.abs(geoLng) : 47.5;

      // frequ√™ncia base em torno de 200Hz e diferen√ßa ~ 8‚Äì12Hz
      let base = 190 + (baseLat % 20);
      let diff = 8 + (baseLng % 4);

      let freq1 = base - diff / 2;
      let freq2 = base + diff / 2;

      osc1 = audioCtx.createOscillator();
      osc2 = audioCtx.createOscillator();

      osc1.type = 'sine';
      osc2.type = 'sine';

      osc1.frequency.value = freq1;
      osc2.frequency.value = freq2;

      const gain = audioCtx.createGain();
      gain.gain.value = 0.07; // volume baixo

      osc1.connect(gain);
      osc2.connect(gain);
      gain.connect(audioCtx.destination);

      osc1.start();
      osc2.start();

      ondasAtivas = true;
      indicator.textContent +=
        ' ¬∑ ONDAS ATIVAS (binaural simb√≥lico ' +
        freq1.toFixed(1) + 'Hz / ' + freq2.toFixed(1) + 'Hz).';
      nvToast('Binaural solar ativado.');
    } else {
      if (osc1) osc1.stop();
      if (osc2) osc2.stop();
      osc1 = null;
      osc2 = null;
      ondasAtivas = false;

      indicator.textContent = indicator.textContent.replace(/ ¬∑ ONDAS ATIVAS.*$/, '');
      nvToast('Binaural solar pausado.');
    }
  } catch (e) {
    indicator.textContent =
      'LOCALIZA√á√ÉO / √ÅUDIO: n√£o foi poss√≠vel iniciar o som (permiss√£o / pol√≠tica do navegador).';
    nvToast('N√£o foi poss√≠vel tocar o √°udio neste navegador.');
  } finally {
    nvStopLoading();
  }
}

/* Arpejo harm√¥nico ligado √† latitude */
function tocarArpejo(ev) {
  ev.stopPropagation();
  nvEnsureAudioCtx().then(() => {
    if (arpOsc) {
      try { arpOsc.stop(); } catch(e) {}
      arpOsc = null;
      nvToast('Arpejo harm√¥nico desligado.');
      return;
    }

    arpOsc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    gain.gain.value = 0.14;

    // escala harm√¥nica baseada na latitude
    const scale = [1, 1.2, 1.25, 1.33, 1.5, 1.6, 2];
    let base = 200 + ((geoLat ?? 23.4) % 40);

    let i = 0;
    const intervalId = setInterval(() => {
      if (!arpOsc) {
        clearInterval(intervalId);
        return;
      }
      arpOsc.frequency.value = base * scale[i % scale.length];
      i++;
    }, 480);

    arpOsc.type = "sine";
    arpOsc.connect(gain);
    gain.connect(audioCtx.destination);
    arpOsc.start();

    nvToast('Arpejo harm√¥nico solar ativado.');
  });
}

/* DICAS META-HUMANO-M√ÅQUINA */
function gerarDicas(ev) {
  ev.stopPropagation();
  nvStartLoading();
  var tipsIndicator = document.getElementById('tipsIndicator');
  var container = document.getElementById('tipsContainer');

  const agora = new Date();
  const hora = agora.getHours();

  let periodo;
  if (hora < 12) periodo = 'manh√£';
  else if (hora < 18) periodo = 'tarde';
  else periodo = 'noite';

  tipsIndicator.textContent =
    'DICAS: Ciclo gerado para o per√≠odo atual (' + periodo.toUpperCase() + ').';

  const latInfo = geoLat != null ? geoLat.toFixed(2) : 'lat n√£o definida';
  const lngInfo = geoLng != null ? geoLng.toFixed(2) : 'lng n√£o definida';

  const dicas = [
    {
      titulo: 'Manh√£ ‚Äî Corpo & Painel',
      texto:
        'Alongar ombros e coluna por 3 minutos olhando para a luz natural. ' +
        'Checar mentalmente: ‚Äúmeu corpo est√° recebendo luz como o telhado recebe o sol?‚Äù. ' +
        'Se poss√≠vel, abrir uma janela e imaginar os pain√©is carregando junto com voc√™.',
    },
    {
      titulo: 'Tarde ‚Äî Foco & Processamento',
      texto:
        'Escolher uma tarefa importante e execut√°-la em bloco de 25 minutos. ' +
        'Pensar nos micro data centers locais: processar o que √© essencial agora, ' +
        'deixar o resto para outro ciclo. Menos abas abertas, mais qualidade de energia mental.',
    },
    {
      titulo: 'Noite ‚Äî Descarregar & Armazenar',
      texto:
        'Reduzir luz forte 1h antes de dormir. Registrar em 3 linhas o que voc√™ ‚Äúcarregou‚Äù hoje: ' +
        'aprendizados, decis√µes, sensa√ß√µes. Assim como a bateria do sistema solar, ' +
        'voc√™ armazena o essencial para o dia seguinte sem sobrecarregar o corpo.',
    }
  ];

  container.innerHTML = '';

  dicas.forEach(function(d) {
    const div = document.createElement('div');
    div.className = 'tip-block';
    div.innerHTML =
      '<strong>' + d.titulo + '</strong>' +
      '<span>' + d.texto + '</span>';
    container.appendChild(div);
  });

  const extra = document.createElement('p');
  extra.style.marginTop = '8px';
  extra.style.fontSize = '0.78rem';
  extra.style.color = 'var(--muted)';
  extra.textContent =
    'Geo base simb√≥lica atual: ' + latInfo + ' / ' + lngInfo +
    ' ¬∑ corpo humano e corpo da rede aprendendo juntos.';
  container.appendChild(extra);

  nvStopLoading();
  nvToast('Dicas Meta-Humano-M√°quina geradas.');
}

/* GERADOR DE TEMPLATES LIVRO VIVO + TTS */
function nvGenerateTemplate(tipo) {
  nvStartLoading();
  const ta = document.getElementById('nv-template-output');
  if (!ta) {
    nvStopLoading();
    return;
  }

  let md = '';

  if (tipo === 'basico') {
    md = [
      '# ‚òÄÔ∏è Projeto Solar B√°sico ‚Äî Nos.S¬∞lar ¬∑ dual.infodose',
      '',
      '::info',
      'Proposta inicial de micro-usina solar conectada √† camada simb√≥lica do Nos.S¬∞lar.',
      'Este documento pode ser expandido no InfoDocs / Livro Vivo.',
      '::',
      '',
      '## üéØ Objetivo',
      '- Reduzir custos de energia;',
      '- Criar base para micro data center local;',
      '- Conectar o im√≥vel √† rede simb√≥lica Nos.S¬∞lar.',
      '',
      '## üìç Local & Perfil de Consumo',
      '- Endere√ßo / Bairro:',
      '- Consumo m√©dio (kWh/m√™s):',
      '- Telhado dispon√≠vel (m¬≤) / orienta√ß√£o:',
      '',
      '## ‚öôÔ∏è Dimensionamento Inicial',
      '- Pot√™ncia estimada (kWp):',
      '- N¬∫ de m√≥dulos:',
      '- Inversor / microinversores:',
      '',
      '## ü§ù Modelo de Parceria',
      '- Tipo: Equity / Servi√ßo / H√≠brido;',
      '- Participa√ß√£o proposta;',
      '- Benef√≠cios para o cliente;',
      '- Benef√≠cios para a rede Nos.S¬∞lar.',
      '',
      '## üì° Camada Digital & Simb√≥lica',
      '- Integra√ß√£o com painel Nos.S¬∞lar;',
      '- Monitoramento simb√≥lico (estado solar, dicas);',
      '- Rotina 3¬∑6¬∑9 de revis√£o energ√©tica.',
      ''
    ].join('\n');
  } else if (tipo === 'escola') {
    md = [
      '# üè´ Educa√ß√£o Solar em Escolas ‚Äî Nos.S¬∞lar ¬∑ dual.infodose',
      '',
      '::info',
      'Documento-modelo para projetos de educa√ß√£o solar em escolas,',
      'conectando energia, tecnologia e forma√ß√£o de estudantes.',
      '::',
      '',
      '## üéØ Objetivos do Programa',
      '- Ensinar fundamentos de energia solar;',
      '- Integrar laborat√≥rio vivo (telhado da escola);',
      '- Conectar trilhas 3¬∑6¬∑9 de forma√ß√£o (alunos, professores, comunidade).',
      '',
      '## üß© Componentes do Projeto',
      '- Instala√ß√£o de sistema fotovoltaico (mini-usina);',
      '- Painel Nos.S¬∞lar na escola (visualiza√ß√£o em tempo real);',
      '- Atividades did√°ticas (experimentos, desafios, jogos).',
      '',
      '## üìö Trilhas 3¬∑6¬∑9',
      '- 3 encontros introdut√≥rios (energia, sol, comunidade);',
      '- 6 encontros pr√°ticos (medi√ß√£o, dados, projeto);',
      '- 9 atividades abertas (feiras, apresenta√ß√µes, mentorias).',
      '',
      '## ü§ù Parcerias',
      '- Empresa de solar / Parque Tecnol√≥gico;',
      '- Secretaria de Educa√ß√£o / Prefeitura;',
      '- Comunidade local / associa√ß√µes.',
      '',
      '## üîÅ Monitoramento & Expans√£o',
      '- M√©tricas de aprendizado;',
      '- Economia de energia;',
      '- Rotas para expans√£o a outros bairros / escolas.',
      ''
    ].join('\n');
  } else if (tipo === 'parque') {
    md = [
      '# üè≠ Parque Tecnol√≥gico & Micro Data Center Solar ‚Äî Nos.S¬∞lar',
      '',
      '::info',
      'Modelo de documento para integrar parque tecnol√≥gico, empresas residentes e',
      'micro data centers alimentados por energia solar distribu√≠da.',
      '::',
      '',
      '## üéØ Vis√£o Geral',
      '- Transformar o parque em n√≥ central da rede Nos.S¬∞lar;',
      '- Alojar micro data centers dedicados a IA / servi√ßos digitais;',
      '- Construir spin-off cooperativa com empresas parceiras.',
      '',
      '## üß± Componentes de Infraestrutura',
      '- Telhados e √°reas dispon√≠veis para pain√©is;',
      '- Sala t√©cnica / cont√™iner de dados (micro data center);',
      '- Conectividade (fibra, redund√¢ncia, monitoramento).',
      '',
      '## ü§ù Modelo de Participa√ß√£o (Equity / Receita)',
      '- Percentual de participa√ß√£o por empresa;',
      '- Regras de entrada / sa√≠da;',
      '- Uso da marca ‚ÄúNos.S¬∞lar ‚Äî dual.infodose";',
      '- Mecanismos de reinvestimento no pr√≥prio parque.',
      '',
      '## üîß Stack Digital & Simb√≥lica',
      '- Pain√©is web / apps m√≥veis (como este Nos.S¬∞lar);',
      '- Monitoramento de energia + uso de servidores;',
      '- Integra√ß√£o com Livro Vivo / InfoDocs para documenta√ß√£o cont√≠nua.',
      '',
      '## üî≠ Roadmap 5‚Äì10 anos',
      '- Expans√£o para bairros e cidades vizinhas;',
      '- Parcerias com iniciativas africanas (Afrikafuturo);',
      '- Conex√£o com hubs solares globais.',
      ''
    ].join('\n');
  }

  ta.value = md;

  try {
    localStorage.setItem('nossolar_last_template', md);
  } catch(e) {}

  nvStopLoading();
  nvToast('Template Livro Vivo gerado.');
}

/* TTS b√°sico de boas-vindas */
let nvTtsInitDone = false;
let nvVoices = [];

function nvInitVoices() {
  if (!('speechSynthesis' in window)) return;
  nvVoices = window.speechSynthesis.getVoices() || [];
  nvTtsInitDone = true;
}

if ('speechSynthesis' in window) {
  window.speechSynthesis.onvoiceschanged = function() {
    nvInitVoices();
  };
  nvInitVoices();
}

function nvPickPtBrVoice() {
  if (!nvVoices || !nvVoices.length) return null;
  // Procura vozes PT-BR primeiro
  let pt = nvVoices.find(v =>
    /pt[-_]?BR/i.test(v.lang || '') ||
    /portuguese.*brazil/i.test((v.name || '') + ' ' + (v.lang || ''))
  );
  if (pt) return pt;
  // fallback para qualquer PT
  pt = nvVoices.find(v => /^pt[-_]/i.test(v.lang || ''));
  if (pt) return pt;
  return nvVoices[0] || null;
}

function nvSpeakWelcome() {
  const text =
    'Bem-vindo ao painel Nos Solar, dual Infodose. ' +
    'Aqui voc√™ conecta energia, dados e livro vivo em um s√≥ lugar. ' +
    'Gere um template, leve para o InfoDocs e continue o fluxo do seu projeto solar.';

  if (!('speechSynthesis' in window)) {
    alert(text);
    return;
  }

  const utter = new SpeechSynthesisUtterance(text);
  const voice = nvPickPtBrVoice();
  if (voice) utter.voice = voice;
  utter.rate = 1.02;
  utter.pitch = 1.0;
  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(utter);
}

/* LS STATUS interno do Nos.S¬∞lar */
function nvLsScan() {
  nvStartLoading();
  const out = document.getElementById('nv-ls-output');
  if (!out) {
    nvStopLoading();
    return;
  }

  try {
    const ls = window.localStorage;
    const len = ls.length;
    let totalBytes = 0;
    let lines = [];

    for (let i = 0; i < len; i++) {
      const key = ls.key(i);
      const val = ls.getItem(key);
      const size = (key.length + (val ? val.length : 0)) * 2; // aprox bytes
      totalBytes += size;
      lines.push('- ' + key + '  ~  ' + size + ' bytes aprox.');
    }

    const header =
      'Chaves armazenadas: ' + len + '\n' +
      'Tamanho aproximado total: ' + totalBytes + ' bytes\n';

    out.textContent = header + (lines.length ? '\n' + lines.join('\n') : '\n(nenhuma chave encontrada)');
  } catch (e) {
    out.textContent = 'Erro ao ler localStorage: ' + e;
  }

  nvStopLoading();
  nvToast('Leitura de localStorage conclu√≠da.');
}

function nvLsClear() {
  const out = document.getElementById('nv-ls-output');
  if (!out) return;
  if (!window.confirm('Deseja limpar as chaves do Nos.S¬∞lar neste navegador?')) return;

  nvStartLoading();
  try {
    const ls = window.localStorage;
    // Limpa apenas chaves com prefixo nossolar_
    const toRemove = [];
    for (let i = 0; i < ls.length; i++) {
      const key = ls.key(i);
      if (key && key.indexOf('nossolar_') === 0) {
        toRemove.push(key);
      }
    }
    toRemove.forEach(k => ls.removeItem(k));

    out.textContent =
      'Chaves com prefixo "nossolar_" removidas. ' +
      'Use "Ver estado atual do LS" para conferir.';
  } catch (e) {
    out.textContent = 'Erro ao limpar localStorage: ' + e;
  }
  nvStopLoading();
  nvToast('Chaves locais do Nos.S¬∞lar limpas.');
}

/* An√°lise de ambiente (loader + m√©tricas em card bonitinho) */
function nvAnalyzeEnv(ev) {
  ev.stopPropagation();
  nvStartLoading();

  const box = document.getElementById('envMetrics');
  if (!box) {
    nvStopLoading();
    return;
  }

  const now = new Date();
  const horas = String(now.getHours()).padStart(2, '0');
  const mins = String(now.getMinutes()).padStart(2, '0');
  const horaStr = horas + ':' + mins;

  const ciclo = nvGetSolarModeLabel();
  const latInfo = geoLat != null ? geoLat.toFixed(4) : 'n√£o definido';
  const lngInfo = geoLng != null ? geoLng.toFixed(4) : 'n√£o definido';

  // Estimativa simb√≥lica de "carga" com base no hor√°rio
  let carga;
  if (now.getHours() < 6) carga = 'baixa (pr√©-alvorada)';
  else if (now.getHours() < 11) carga = 'subindo (manh√£ ativa)';
  else if (now.getHours() < 15) carga = 'alta (pico solar)';
  else if (now.getHours() < 19) carga = 'est√°vel (fim de tarde)';
  else carga = 'descendo (noite / descarregar)';

  let recomendacao;
  if (now.getHours() < 11) {
    recomendacao =
      'Bom momento para tarefas criativas e planejamento. ' +
      'Use a luz da manh√£ como ‚Äúenergia gr√°tis‚Äù para o c√©rebro.';
  } else if (now.getHours() < 18) {
    recomendacao =
      'Priorize execu√ß√£o focada. Menos abas, mais profundidade. ' +
      'Imagine que cada decis√£o bem tomada √© um painel rendendo mais.';
  } else {
    recomendacao =
      'Comece a desacelerar. Feche ciclos, descarregue tens√µes e prepare o corpo ' +
      'para armazenar o essencial do dia, sem sobrecarga.';
  }

  box.innerHTML = `
    <div class="env-card">
      <h4>Leitura r√°pida do ambiente</h4>
      <small>Nos.S¬∞lar ¬∑ an√°lise simb√≥lica local</small>
      <div class="env-grid">
        <div class="env-row">
          <span class="env-label">Hor√°rio local</span>
          <span class="env-value">${horaStr}</span>
        </div>
        <div class="env-row">
          <span class="env-label">Ciclo solar</span>
          <span class="env-value">${ciclo}</span>
        </div>
        <div class="env-row">
          <span class="env-label">Lat / Lng base</span>
          <span class="env-value">${latInfo} / ${lngInfo}</span>
        </div>
        <div class="env-row">
          <span class="env-label">Carga simb√≥lica</span>
          <span class="env-value">${carga}</span>
        </div>
      </div>
      <p style="margin-top:8px;font-size:0.8rem;color:var(--muted);">
        ${recomendacao}
      </p>
    </div>
  `;

  nvStopLoading();
  nvToast('Ambiente solar analisado.');
}
</script>

 <!-- PATCH: UNIFICA√á√ÉO EM 3 CARDS ¬∑ NOS.S¬∞LAR -->
<style>
/* Subcards dentro do card principal (welcome + LS + ambiente, geo + dicas) */

/* Cards mais "Livro Vivo" ‚Äì borda e brilho */
.card {
  border-radius: 16px;
  background: radial-gradient(circle at 0 0, rgba(125, 211, 252, 0.12), transparent 55%),
              rgba(5, 13, 24, 0.96);
  box-shadow:
    0 22px 60px rgba(0, 0, 0, 0.7),
    0 0 0 1px rgba(148, 163, 184, 0.18);
}

/* Container interno com largura "coluna de leitura" */
.card-body-inner {
  max-width: 720px;
  margin: 0 auto;
  padding: 10px 0 16px;
}

/* Primeira linha estilo t√≠tulo MD agressivo */
.card-body-inner p:first-of-type {
  margin: 0 0 10px;
  padding-left: 12px;
  font-size: 0.92rem;
  font-weight: 500;
  color: #e5f4ff;
  border-left: 2px solid var(--accent);
}

.card-body-inner p:first-of-type::before {
  left: -10px;
  font-size: 0.82rem;
}



.nv-subcard {
  margin-top: 14px;
  padding-top: 10px;
  border-top: 1px dashed rgba(148, 163, 184, 0.45);
}

/* Caso ainda n√£o tenha essa classe (refor√ßa estilo Livro Vivo) */
.nv-subtitle {
  margin-top: 14px !important;
  margin-bottom: 6px !important;
  font-size: 0.78rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.22em;
  color: #c7e6ff;
  position: relative;
  padding-left: 8px;
}
.nv-subtitle::before {
  content: "";
  position: absolute;
  left: 0;
  top: 50%;
  width: 4px;
  height: 14px;
  transform: translateY(-50%);
  border-radius: 999px;
  background: linear-gradient(180deg, #7dd3fc, #22c55e);
}

/* Container interno com largura "coluna de leitura" */
.card-body-inner {
  max-width: 720px;
  margin: 0 auto;
  padding: 10px 0 16px;
}

/* Primeira linha estilo t√≠tulo MD agressivo */
.card-body-inner p:first-of-type {
  margin: 0 0 10px;
  padding-left: 12px;
  font-size: 0.92rem;
  font-weight: 500;
  color: #e5f4ff;
  border-left: 2px solid var(--accent);
}

.card-body-inner p:first-of-type::before {
  left: -10px;
  font-size: 0.82rem;
}

/* Par√°grafos seguintes com respiro melhor */
.card-body-inner p + p {
  margin-top: 6px;
  font-size: 0.88rem;
}

/* Tag ::info / ::hub / etc ‚Äì mais chip "doc t√©cnico" */
.md-tag {
  font-size: 0.72rem;
  padding: 3px 10px;
  border-radius: 999px;
  background: rgba(15, 23, 42, 0.96);
  border: 1px solid rgba(148, 163, 184, 0.7);
  box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.9);
}

/* Linha de bot√µes mais separada do texto */
.btn-row {
  margin-top: 10px;
}

/* Bot√µes com vibe InfoDocs (prim√°rio agressivo) */
.btn {
  font-size: 0.9rem;
  text-transform: none;
  letter-spacing: 0.03em;
  background: radial-gradient(circle at 0 0, rgba(125, 211, 252, 0.35), rgba(255, 255, 255, 0.06));
  border: 1px solid rgba(148, 163, 184, 0.55);
}

.btn:hover {
  background: radial-gradient(circle at 0 0, rgba(125, 211, 252, 0.6), rgba(255, 255, 255, 0.12));
  box-shadow:
    0 0 20px rgba(125, 211, 252, 0.35),
    0 0 0 1px rgba(15, 23, 42, 0.9);
}

/* Tip-block (dicas) ‚Äì callout bonitinho */
#tipsContainer .tip-block {
  margin-top: 8px;
  padding: 8px 10px;
  border-radius: 10px;
  background: rgba(15, 23, 42, 0.96);
  border: 1px solid rgba(148, 163, 184, 0.65);
  box-shadow:
    0 12px 26px rgba(0, 0, 0, 0.7),
    0 0 0 1px rgba(15, 23, 42, 0.9);
  display: flex;
  flex-direction: column;
  gap: 4px;
}

#tipsContainer .tip-block strong {
  font-size: 0.86rem;
  letter-spacing: 0.05em;
  text-transform: uppercase;
  color: #e5f4ff;
}

#tipsContainer .tip-block span {
  font-size: 0.8rem;
  color: #cbd5f5;
}

/* Indicadores (modo, geo, dicas) com micro-label */
.mode-indicator,
.geo-indicator,
.tips-indicator {
  margin-top: 10px;
  font-size: 0.74rem;
  letter-spacing: 0.18em;
  color: #9fb9ff;
}

/* Header do app levemente mais ‚Äúdoc‚Äù que ‚Äúlanding‚Äù */
.app-title {
  font-size: 1.32rem;
  letter-spacing: 0.12em;
}

.app-subtitle {
  font-size: 0.82rem;
  max-width: 320px;
  margin: 0 auto;
}

/* Wave visual um pouco mais discreta (fundo de leitura) */
.wave-container {
  margin-top: 12px;
  opacity: 0.85;
}

.wave {
  background: repeating-linear-gradient(
    to right,
    rgba(125, 211, 252, 0.08) 0,
    rgba(125, 211, 252, 0.6) 2px,
    transparent 6px
  );
}

/* Pequeno respiro extra abaixo de cada card */
.card-stack .card + .card {
  margin-top: 2px;
}
</style>

<script>
/* Unifica√ß√£o dos cards em 3 blocos:
   1) welcome + ls + env
   2) solar (inalterado)
   3) geo + tips
*/
document.addEventListener('DOMContentLoaded', function () {
  try {
    // --- Host principal do primeiro card (Boas-vindas / Livro Vivo) ---
    const welcomeInner = document.querySelector('.card[data-card="welcome"] .card-body-inner');

    const lsCard  = document.querySelector('.card[data-card="ls"]');
    const envCard = document.querySelector('.card[data-card="env"]');
    const tipsCard = document.querySelector('.card[data-card="tips"]');
    const geoInner = document.querySelector('.card[data-card="geo"] .card-body-inner');

    // 1) Juntar LS dentro do card de Boas-vindas
    if (welcomeInner && lsCard) {
      const lsInner = lsCard.querySelector('.card-body-inner');
      if (lsInner) {
        const wrap = document.createElement('div');
        wrap.className = 'nv-subcard';
        wrap.innerHTML =
          '<p class="nv-subtitle">LocalStorage ¬∑ Estado interno do Nos.S¬∞lar</p>' +
          lsInner.innerHTML;
        welcomeInner.appendChild(wrap);
      }
      lsCard.remove();
    }

    // 2) Juntar Ambiente dentro do card de Boas-vindas
    if (welcomeInner && envCard) {
      const envInner = envCard.querySelector('.card-body-inner');
      if (envInner) {
        const wrap = document.createElement('div');
        wrap.className = 'nv-subcard';
        wrap.innerHTML =
          '<p class="nv-subtitle">Leitura r√°pida do ambiente solar</p>' +
          envInner.innerHTML;
        welcomeInner.appendChild(wrap);
      }
      envCard.remove();
    }

    // 3) Juntar Dicas dentro do card de Geo
    if (geoInner && tipsCard) {
      const tipsInner = tipsCard.querySelector('.card-body-inner');
      if (tipsInner) {
        const wrap = document.createElement('div');
        wrap.className = 'nv-subcard';
        wrap.innerHTML =
          '<p class="nv-subtitle">Dicas Meta-Humano-M√°quina ¬∑ manh√£ ¬∑ tarde ¬∑ noite</p>' +
          tipsInner.innerHTML;
        geoInner.appendChild(wrap);
      }
      tipsCard.remove();
    }

   
}
   catch (e) {
    console.warn('Patch de unifica√ß√£o de cards falhou:', e);
  }
});
</script>
 
</body>
</html>
