<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Nos.S¬∞lar ‚Äî Stack Solar Din√¢mica</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

<style>
/* MOBILE-FIRST VERTICAL HARD-LOCK */

/* Tokens Nebula Pro Solar */
:root {
  --bg-day: radial-gradient(circle at 20% 10%, #fff9c4 0%, #ffe082 35%, #ffb74d 70%, #ff9800 100%);
  --bg-sunset: radial-gradient(circle at 10% 0%, #ffd180 0%, #ff8a65 30%, #f06292 60%, #7e57c2 100%);
  --bg-night: radial-gradient(circle at 20% 0%, #0b1020 0%, #121c3b 40%, #1a237e 80%, #000000 100%);

  --panel: #050d18cc;
  --ink: #eafcff;
  --muted: #9fb3cc;

  --accent: #7dd3fc;
  --accent-soft: rgba(125, 211, 252, 0.18);

  --sun-scale: 1;
}

*,
*::before,
*::after {
  box-sizing: border-box;
}

html, body {
  margin: 0;
  padding: 0;
}

body {
  min-height: 100vh;
  font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  color: var(--ink);
  display: flex;
  flex-direction: column;
  align-items: stretch;
  justify-content: flex-start;
  background: var(--bg-day);
  transition: background 4s ease-in-out;
  overflow-x: hidden;
}

/* SPLASH / LOADER NOS.S¬∞LAR */
#splash-nosolar {
  position: fixed;
  inset: 0;
  z-index: 50;
  background: radial-gradient(circle at 20% 0%, #ffe082 0%, #ffb74d 20%, #ff7043 45%, #311b92 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  pointer-events: auto;
  transition: opacity 0.7s ease, transform 0.7s ease;
}

#splash-nosolar.hide {
  opacity: 0;
  transform: scale(1.02);
  pointer-events: none;
}

.splash-inner {
  text-align: center;
  color: #fffde7;
}

.splash-circle {
  width: 120px;
  height: 120px;
  border-radius: 999px;
  border: 2px solid rgba(255, 255, 255, 0.35);
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 14px;
  box-shadow:
    0 0 40px rgba(255, 241, 118, 0.9),
    0 0 0 1px rgba(255, 255, 255, 0.15);
  position: relative;
  overflow: hidden;
  background: radial-gradient(circle at 50% 40%, #fffde7 0%, #ffca28 40%, #f57c00 80%);
}

.splash-circle::after {
  content: "";
  position: absolute;
  bottom: -10%;
  left: 50%;
  width: 140%;
  height: 70%;
  transform: translateX(-50%);
  background: radial-gradient(circle at 50% 120%, rgba(0,0,0,0.7) 0%, transparent 70%);
  opacity: 0.65;
}

.splash-portal {
  width: 46px;
  height: 68px;
  border-radius: 46px 46px 20px 20px;
  border: 2px solid rgba(33, 33, 33, 0.9);
  background: radial-gradient(circle at 50% 0%, #fff9c4 0%, #ffb74d 35%, #4a148c 100%);
  box-shadow:
    0 0 18px rgba(255, 241, 118, 0.9),
    0 0 0 1px rgba(255, 255, 255, 0.4);
  position: relative;
  overflow: hidden;
}

.splash-portal::before {
  content: "";
  position: absolute;
  inset: 18% 22%;
  border-radius: 999px;
  border: 1px solid rgba(255, 255, 255, 0.8);
  box-shadow: 0 0 14px rgba(255, 255, 255, 0.7);
}

.splash-text {
  font-size: 1.1rem;
  font-weight: 800;
  letter-spacing: 0.08em;
  text-transform: uppercase;
}

.splash-sub {
  margin-top: 6px;
  font-size: 0.82rem;
  opacity: 0.9;
}

/* Loader operacional (aparece se demorar > 600ms) */
#nv-loader {
  position: fixed;
  inset: 0;
  z-index: 40;
  background: radial-gradient(circle at 20% 0%, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.35));
  display: flex;
  align-items: flex-end;
  justify-content: center;
  padding-bottom: 32px;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.3s ease;
}

#nv-loader.visible {
  opacity: 1;
  pointer-events: auto;
}

.nv-loader-inner {
  display: inline-flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  padding: 8px 14px;
  border-radius: 999px;
  background: rgba(15, 23, 42, 0.95);
  border: 1px solid rgba(148, 163, 184, 0.6);
  box-shadow: 0 16px 40px rgba(0, 0, 0, 0.7);
  color: #e5e7eb;
  font-size: 0.78rem;
}

.nv-loader-orbit {
  width: 20px;
  height: 20px;
  border-radius: 999px;
  border: 2px solid rgba(148, 163, 184, 0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
}

.nv-loader-dot {
  position: absolute;
  width: 6px;
  height: 6px;
  border-radius: 999px;
  background: #facc15;
  box-shadow: 0 0 8px rgba(250, 204, 21, 0.9);
  animation: loader-orbit 1.1s linear infinite;
}

/* Camada de c√©u e part√≠culas */
.sky-layer {
  position: fixed;
  inset: 0;
  overflow: hidden;
  z-index: 0;
  pointer-events: none;
}

.sun {
  position: absolute;
  width: 160px;
  height: 160px;
  border-radius: 50%;
  background: radial-gradient(circle at 30% 30%, #fffde7 0%, #fff176 40%, #ffb300 100%);
  filter: blur(0.5px);
  opacity: 0.9;
  animation: sun-orbit 24s linear infinite;
  box-shadow: 0 0 60px rgba(255, 236, 179, 0.85);
}

.particle {
  position: absolute;
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.8);
  box-shadow: 0 0 12px rgba(255, 255, 255, 0.9);
  opacity: 0.8;
  animation: float-particle 14s linear infinite;
}

.p1 { left: 10%; top: 70%; animation-delay: -2s; }
.p2 { left: 30%; top: 80%; animation-delay: -6s; }
.p3 { left: 55%; top: 65%; animation-delay: -10s;}
.p4 { left: 75%; top: 85%; animation-delay: -4s; }
.p5 { left: 90%; top: 75%; animation-delay: -8s; }

/* Shell principal */
.app-shell {
  position: relative;
  z-index: 1;
  padding: 18px 12px 24px;
  display: flex;
  flex-direction: column;
  align-items: stretch;
  gap: 16px;
}

/* Header */
.app-header {
  text-align: center;
}

.tag-solar {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-size: 0.82rem;
  padding: 4px 9px;
  border-radius: 999px;
  background: rgba(255, 235, 59, 0.08);
  border: 1px solid rgba(255, 235, 59, 0.45);
  color: #fffde7;
}

.app-title {
  font-size: 1.4rem;
  font-weight: 800;
  letter-spacing: 0.04em;
  text-transform: uppercase;
  text-shadow: 0 0 18px rgba(0, 0, 0, 0.6);
  margin: 6px 0 4px;
}

.app-subtitle {
  font-size: 0.85rem;
  color: var(--muted);
}

/* STACK DE CARDS (SANFONA) */
.card-stack {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

/* Card / Sanfona */
.card {
  background: var(--panel);
  border-radius: 14px;
  backdrop-filter: blur(12px);
  box-shadow:
    0 18px 40px rgba(0, 0, 0, 0.45),
    0 0 0 1px rgba(255, 255, 255, 0.03);
  overflow: hidden;
}

/* Estilo Nebula Pro / Markdown visual nas headers */
.card-header {
  padding: 14px 14px;
  display: flex;
  flex-direction: row;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
}

.card-title {
  font-size: 0.98rem;
  font-weight: 600;
}

.card-header small {
  font-size: 0.78rem;
  color: var(--muted);
}

.card-toggle {
  font-size: 1.1rem;
  opacity: 0.7;
}

/* Corpo dos cards */
.card-body {
  max-height: 0;
  overflow: hidden;
  padding: 0 14px;
  transition:
    max-height 0.4s ease,
    padding-top 0.3s ease,
    padding-bottom 0.3s ease;
}

.card-body-inner {
  padding: 6px 0 12px;
}

/* BLOCO ESTILO MARKDOWN */
.card-body-inner p:first-of-type {
  position: relative;
  margin: 0 0 8px;
  padding-left: 10px;
  font-size: 0.9rem;
  color: var(--muted);
}

.card-body-inner p:first-of-type::before {
  content: "#";
  position: absolute;
  left: -2px;
  top: 0;
  font-size: 0.78rem;
  color: var(--accent);
  opacity: 0.9;
}

/* Par√°grafos seguintes */
.card-body-inner p + p {
  margin-top: 4px;
}

/* Tagzinha de linha (como ::info) */
.md-tag {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  padding: 2px 8px;
  border-radius: 999px;
  background: rgba(15, 23, 42, 0.9);
  border: 1px solid rgba(148, 163, 184, 0.5);
  color: #e5e7eb;
}

/* Linha de bot√µes */
.btn-row {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-top: 8px;
}

.btn {
  display: inline-flex;
  width: 100%;
  justify-content: center;
  align-items: center;
  padding: 10px 14px;
  border-radius: 999px;
  border: none;
  background: rgba(255, 255, 255, 0.16);
  color: var(--ink);
  font-size: 0.92rem;
  font-weight: 600;
  letter-spacing: 0.02em;
  cursor: pointer;
  backdrop-filter: blur(6px);
  transition:
    background 0.3s ease,
    transform 0.2s ease,
    box-shadow 0.3s ease;
}

.btn span {
  margin-left: 6px;
}

.btn:active {
  transform: scale(0.97);
}

.btn:hover {
  background: rgba(255, 255, 255, 0.26);
  box-shadow: 0 0 22px rgba(255, 255, 255, 0.18);
}

/* Indicadores */
.mode-indicator,
.geo-indicator,
.tips-indicator {
  margin-top: 8px;
  font-size: 0.8rem;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  color: var(--muted);
}

/* Ondas sonoras visuais */
.wave-container {
  position: relative;
  margin-top: 10px;
  height: 40px;
  overflow: hidden;
}

.wave {
  position: absolute;
  inset: 0;
  background: repeating-linear-gradient(
    to right,
    rgba(144, 202, 249, 0.2) 0,
    rgba(144, 202, 249, 0.8) 2px,
    transparent 4px
  );
  opacity: 0.7;
  transform-origin: left center;
  animation: wave-move 3s linear infinite;
}

.wave.wave2 {
  opacity: 0.4;
  animation-duration: 5s;
}

/* √Årea do template do Livro Vivo */
#nv-template-output {
  width: 100%;
  min-height: 120px;
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.12);
  background: rgba(2,6,23,0.7);
  color: var(--ink);
  padding: 8px 10px;
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-size: 0.85rem;
  resize: vertical;
}

/* Resultado LS */
#nv-ls-output {
  width: 100%;
  min-height: 80px;
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.12);
  background: rgba(2,6,23,0.7);
  color: var(--ink);
  padding: 8px 10px;
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-size: 0.8rem;
  white-space: pre-wrap;
}

/* Modos de fundo & sol/lua */
body.mode-day {
  background: var(--bg-day);
  --sun-scale: 1;
}

body.mode-sunset {
  background: var(--bg-sunset);
  --sun-scale: 0.9;
}

body.mode-night {
  background: var(--bg-night);
  --sun-scale: 0.65;
}

body.mode-day .sun,
body.mode-sunset .sun {
  background: radial-gradient(circle at 30% 30%, #fffde7 0%, #fff176 40%, #ffb300 100%);
  box-shadow: 0 0 60px rgba(255, 236, 179, 0.85);
}

body.mode-night .sun {
  background: radial-gradient(circle at 30% 30%, #e8f5ff 0%, #bbdefb 45%, #90caf9 100%);
  box-shadow: 0 0 40px rgba(187, 222, 251, 0.85);
}

/* Anima√ß√µes */
@keyframes sun-orbit {
  0% {
    transform: translate(-20%, 10%) scale(var(--sun-scale));
  }
  25% {
    transform: translate(40%, -10%) scale(var(--sun-scale));
  }
  50% {
    transform: translate(80%, 15%) scale(var(--sun-scale));
  }
  75% {
    transform: translate(40%, 35%) scale(var(--sun-scale));
  }
  100% {
    transform: translate(-20%, 10%) scale(var(--sun-scale));
  }
}

@keyframes float-particle {
  0% {
    transform: translateY(0px) scale(1);
    opacity: 0.2;
  }
  20% {
    opacity: 0.8;
  }
  50% {
    transform: translateY(-40px) scale(1.2);
  }
  80% {
    opacity: 0.4;
  }
  100% {
    transform: translateY(-80px) scale(0.9);
    opacity: 0;
  }
}

@keyframes wave-move {
  0% { transform: translateX(0) skewX(-8deg); }
  100% { transform: translateX(-40px) skewX(-8deg); }
}

@keyframes loader-orbit {
  0% { transform: rotate(0deg) translateX(7px) rotate(0deg); }
  100% { transform: rotate(360deg) translateX(7px) rotate(-360deg); }
}

/* Responsive */
@media (min-height: 780px) {
  .app-shell {
    padding-top: 26px;
  }
}
</style>
</head>
<body class="mode-day">
  <!-- Splash de abertura do holar -->
  <div id="splash-nosolar">
    <div class="splash-inner">
      <div class="splash-circle">
        <div class="splash-portal"></div>
      </div>
      <div class="splash-text">Nos.S¬∞lar ‚Äî dual.infodose</div>
      <div class="splash-sub">(carregando o holar & o p√¥r do sol na oca...)</div>
    </div>
  </div>

  <!-- Loader operacional -->
  <div id="nv-loader">
    <div class="nv-loader-inner">
      <div class="nv-loader-orbit">
        <div class="nv-loader-dot"></div>
      </div>
      <span>Sincronizando Nos.S¬∞lar‚Ä¶</span>
    </div>
  </div>

  <div class="sky-layer">
    <div class="sun"></div>
    <div class="particle p1"></div>
    <div class="particle p2"></div>
    <div class="particle p3"></div>
    <div class="particle p4"></div>
    <div class="particle p5"></div>
  </div>

  <div class="app-shell">
    <header class="app-header">
      <div class="tag-solar">
        ‚òÄÔ∏è <span>Nos.S¬∞lar ¬∑ Rede Solar Simb√≥lica</span>
      </div>
      <h1 class="app-title">Stack Solar Din√¢mica</h1>
      <p class="app-subtitle">
        Dia ‚Üí P√¥r do Sol ‚Üí Noite ¬∑ Estado solar local ¬∑ Dicas Meta-Humano-M√°quina ¬∑ Livro Vivo
      </p>
    </header>

    <main class="card-stack">

      <!-- CARD 0: Boas-vindas / Livro Vivo / Gerador + TTS -->
      <section class="card" data-card="welcome">
        <div class="card-header" onclick="toggleCard(this)">
          <div>
            <div class="card-title">Boas-vindas ¬∑ Livro Vivo & InfoDocs</div>
            <small>(gerador ¬∑ TTS ¬∑ ponte com o Hub)</small>
          </div>
          <div class="card-toggle">‚åÑ</div>
        </div>
        <div class="card-body">
          <div class="card-body-inner">
            <p>
              <span class="md-tag">::info</span>
              Este card √© a porta de entrada do <strong>Nos.S¬∞lar</strong> com o
              <strong>Livro Vivo / InfoDocs</strong>: aqui voc√™ gera templates de documentos,
              testa voz (TTS) e copia o conte√∫do direto para o Hub principal.
            </p>

            <div class="btn-row">
              <button class="btn" onclick="nvGenerateTemplate('basico'); event.stopPropagation();">
                ‚ú®<span>Gerar template ‚Äî Documento Solar B√°sico</span>
              </button>
              <button class="btn" onclick="nvGenerateTemplate('escola'); event.stopPropagation();">
                üè´<span>Gerar template ‚Äî Educa√ß√£o Solar em Escolas</span>
              </button>
              <button class="btn" onclick="nvGenerateTemplate('parque'); event.stopPropagation();">
                üè≠<span>Gerar template ‚Äî Parque Tecnol√≥gico & Micro Data Center</span>
              </button>
              <button class="btn" onclick="nvSpeakWelcome(); event.stopPropagation();">
                üîä<span>Ouvir boas-vindas (TTS)</span>
              </button>
            </div>

            <p style="font-size:0.8rem;color:var(--muted);margin-top:8px;">
              Copie o conte√∫do abaixo e cole no painel principal do InfoDocs / Livro Vivo para
              continuar a edi√ß√£o completa.
            </p>

            <textarea id="nv-template-output" placeholder="# Seu template Livro Vivo aparecer√° aqui..."></textarea>
          </div>
        </div>
      </section>

      <!-- CARD 0.5: LS Status interno do Nos.S¬∞lar -->
      <section class="card" data-card="ls">
        <div class="card-header" onclick="toggleCard(this)">
          <div>
            <div class="card-title">LocalStorage ¬∑ Estado interno do Nos.S¬∞lar</div>
            <small>(debug leve ¬∑ chaves ¬∑ espa√ßo)</small>
          </div>
          <div class="card-toggle">‚åÑ</div>
        </div>
        <div class="card-body">
          <div class="card-body-inner">
            <p>
              <span class="md-tag">::ls</span>
              Leitura simb√≥lica do <strong>localStorage</strong> deste micro-app:
              quantas chaves existem, quais s√£o e quanto espa√ßo aproximado ocupam.
            </p>

            <div class="btn-row">
              <button class="btn" onclick="nvLsScan(); event.stopPropagation();">
                üîç<span>Ver estado atual do LS</span>
              </button>
              <button class="btn" onclick="nvLsClear(); event.stopPropagation();">
                üßπ<span>Limpar chaves do Nos.S¬∞lar</span>
              </button>
            </div>

            <p style="font-size:0.8rem;color:var(--muted);margin-top:8px;">
              Este card √© o ‚Äúespelho local‚Äù do armazenamento: perfeito para debug leve sem
              abrir o painel LS_STATUS completo.
            </p>

            <div id="nv-ls-output" aria-label="Sa√≠da de LocalStorage"></div>
          </div>
        </div>
      </section>

      <!-- CARD 1: CICLO SOLAR -->
      <section class="card" data-card="solar">
        <div class="card-header" onclick="toggleCard(this)">
          <div>
            <div class="card-title">Painel Solar Din√¢mico</div>
            <small>(dia ¬∑ p√¥r do sol ¬∑ noite)</small>
          </div>
          <div class="card-toggle">‚åÑ</div>
        </div>
        <div class="card-body">
          <div class="card-body-inner">
            <p>
              <span class="md-tag">::ciclo</span>
              Controle visual do ciclo solar: de <strong>capta√ß√£o m√°xima</strong> √†
              <strong>rede de dados iluminada</strong>.
            </p>
            <div class="btn-row">
              <button class="btn" onclick="setMode('day'); event.stopPropagation();">
                ‚òÄÔ∏è<span>Dia ‚Äî Capta√ß√£o Solar M√°xima</span>
              </button>
              <button class="btn" onclick="setMode('sunset'); event.stopPropagation();">
                üåá<span>P√¥r do Sol ‚Äî Transi√ß√£o Energia ‚Üí Dados</span>
              </button>
              <button class="btn" onclick="setMode('night'); event.stopPropagation();">
                üåô<span>Noite ‚Äî Lua ¬∑ Rede de Dados Ativa</span>
              </button>
            </div>
            <div class="mode-indicator" id="modeIndicator">
              MODO ATUAL: DIA ¬∑ CAPTA√á√ÉO & CARREGAMENTO
            </div>
          </div>
        </div>
      </section>

      <!-- CARD 2: LOCALIZA√á√ÉO & ONDAS SONORAS -->
      <section class="card" data-card="geo">
        <div class="card-header" onclick="toggleCard(this)">
          <div>
            <div class="card-title">Painel Sonoro ¬∑ Estado Solar Local</div>
            <small>(lat/long simb√≥licas + ondas g√™meas)</small>
          </div>
          <div class="card-toggle">‚åÑ</div>
        </div>
        <div class="card-body">
          <div class="card-body-inner">
            <p>
              <span class="md-tag">::geo</span>
              Detecta sua posi√ß√£o na Terra, exibe <strong>lat/long simb√≥licas</strong> e
              ativa duas ondas sonoras que dan√ßam com o seu estado solar.
            </p>
            <div class="btn-row">
              <button class="btn" onclick="pedirLocalizacao(event)">
                üìç<span>Descobrir minha posi√ß√£o solar</span>
              </button>
              <button class="btn" onclick="toggleOndas(event)">
                üîä<span>Ativar / Pausar ondas g√™meas</span>
              </button>
            </div>
            <div class="geo-indicator" id="geoIndicator">
              LOCALIZA√á√ÉO: Aguardando permiss√£o...
            </div>

            <div class="wave-container">
              <div class="wave"></div>
              <div class="wave wave2"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- CARD 3: DICAS META-HUMANO-M√ÅQUINA -->
      <section class="card" data-card="tips">
        <div class="card-header" onclick="toggleCard(this)">
          <div>
            <div class="card-title">Painel de Dicas ¬∑ Meta-Humano-M√°quina</div>
            <small>(manh√£ ¬∑ tarde ¬∑ noite)</small>
          </div>
          <div class="card-toggle">‚åÑ</div>
        </div>
        <div class="card-body">
          <div class="card-body-inner">
            <p>
              <span class="md-tag">::dicas</span>
              Gera tr√™s dicas: <strong>manh√£, tarde e noite</strong>, correlacionando o
              seu corpo com o corpo simbi√≥tico da rede Nos.S¬∞lar.
            </p>
            <div class="btn-row">
              <button class="btn" onclick="gerarDicas(event)">
                üí´<span>Gerar dicas para hoje</span>
              </button>
            </div>
            <div class="tips-indicator" id="tipsIndicator">
              DICAS: Toque para gerar o ciclo de hoje.
            </div>

            <div id="tipsContainer">
              <!-- Dicas aparecem aqui -->
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

<script>
/* SPLASH HANDLER */
window.addEventListener('load', function() {
  var splash = document.getElementById('splash-nosolar');
  if (!splash) return;
  setTimeout(function() {
    splash.classList.add('hide');
    setTimeout(function() {
      splash.style.display = 'none';
    }, 900);
  }, 900);
});

/* LOADER >600ms */
let nvLoaderTimer = null;
function nvStartLoading() {
  const el = document.getElementById('nv-loader');
  if (!el) return;
  if (nvLoaderTimer) clearTimeout(nvLoaderTimer);
  nvLoaderTimer = setTimeout(function() {
    el.classList.add('visible');
  }, 600);
}
function nvStopLoading() {
  const el = document.getElementById('nv-loader');
  if (!el) return;
  if (nvLoaderTimer) {
    clearTimeout(nvLoaderTimer);
    nvLoaderTimer = null;
  }
  el.classList.remove('visible');
}

/* SANFONA DE CARDS */
function toggleCard(headerEl) {
  var card = headerEl.closest('.card');
  var body = card.querySelector('.card-body');
  var toggleIcon = card.querySelector('.card-toggle');

  var isOpen = card.classList.contains('open');
  if (isOpen) {
    card.classList.remove('open');
    body.style.maxHeight = '0px';
    toggleIcon.textContent = '‚åÑ';
  } else {
    card.classList.add('open');
    body.style.maxHeight = body.scrollHeight + 'px';
    toggleIcon.textContent = '‚åÉ';
  }
}

/* Ajusta maxHeight ao redimensionar */
window.addEventListener('resize', function() {
  document.querySelectorAll('.card.open .card-body').forEach(function(body) {
    body.style.maxHeight = body.scrollHeight + 'px';
  });
});

/* CICLO SOLAR */
function setMode(mode) {
  document.body.classList.remove('mode-day', 'mode-sunset', 'mode-night');
  var indicator = document.getElementById('modeIndicator');

  if (mode === 'day') {
    document.body.classList.add('mode-day');
    indicator.textContent = 'MODO ATUAL: DIA ¬∑ CAPTA√á√ÉO & CARREGAMENTO';
  } else if (mode === 'sunset') {
    document.body.classList.add('mode-sunset');
    indicator.textContent = 'MODO ATUAL: P√îR DO SOL ¬∑ TRANSI√á√ÉO ENERGIA ‚Üí DADOS';
  } else if (mode === 'night') {
    document.body.classList.add('mode-night');
    indicator.textContent =
      'MODO ATUAL: NOITE ¬∑ LUA MENOR ¬∑ REDE DE DADOS ILUMINADA PELA ENERGIA DO DIA';
  }
}

/* GEO + ONDAS SONORAS (Web Audio) */
let geoLat = null;
let geoLng = null;
let audioCtx = null;
let osc1 = null;
let osc2 = null;
let ondasAtivas = false;

function pedirLocalizacao(ev) {
  ev.stopPropagation();
  nvStartLoading();
  var indicator = document.getElementById('geoIndicator');

  if (!navigator.geolocation) {
    indicator.textContent = 'LOCALIZA√á√ÉO: Navegador n√£o suporta geolocaliza√ß√£o.';
    nvStopLoading();
    return;
  }

  indicator.textContent = 'LOCALIZA√á√ÉO: Solicitando permiss√£o...';

  navigator.geolocation.getCurrentPosition(function(pos) {
    geoLat = pos.coords.latitude;
    geoLng = pos.coords.longitude;
    indicator.textContent =
      'LOCALIZA√á√ÉO: ' +
      geoLat.toFixed(4) + ' ¬∑ ' +
      geoLng.toFixed(4) +
      ' ‚Äî Estado solar pronto para leitura simb√≥lica.';
    nvStopLoading();
  }, function(err) {
    indicator.textContent = 'LOCALIZA√á√ÉO: Permiss√£o negada ou indispon√≠vel.';
    nvStopLoading();
  }, {
    enableHighAccuracy: false,
    timeout: 8000,
    maximumAge: 60000
  });
}

function toggleOndas(ev) {
  ev.stopPropagation();
  nvStartLoading();
  var indicator = document.getElementById('geoIndicator');

  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }

  if (!ondasAtivas) {
    let baseLat = geoLat != null ? Math.abs(geoLat) : 23.5;
    let baseLng = geoLng != null ? Math.abs(geoLng) : 47.5;

    let freq1 = 80 + (baseLat % 40);
    let freq2 = 160 + (baseLng % 70);

    osc1 = audioCtx.createOscillator();
    osc2 = audioCtx.createOscillator();

    osc1.type = 'sine';
    osc2.type = 'sine';

    osc1.frequency.value = freq1;
    osc2.frequency.value = freq2;

    const gain = audioCtx.createGain();
    gain.gain.value = 0.08;

    osc1.connect(gain);
    osc2.connect(gain);
    gain.connect(audioCtx.destination);

    osc1.start();
    osc2.start();

    ondasAtivas = true;
    indicator.textContent += ' ¬∑ ONDAS ATIVAS (duas frequ√™ncias em resson√¢ncia).';
  } else {
    if (osc1) osc1.stop();
    if (osc2) osc2.stop();
    osc1 = null;
    osc2 = null;
    ondasAtivas = false;

    indicator.textContent = indicator.textContent.replace(/ ¬∑ ONDAS ATIVAS.*$/, '');
  }
  nvStopLoading();
}

/* DICAS META-HUMANO-M√ÅQUINA */
function gerarDicas(ev) {
  ev.stopPropagation();
  nvStartLoading();
  var tipsIndicator = document.getElementById('tipsIndicator');
  var container = document.getElementById('tipsContainer');

  const agora = new Date();
  const hora = agora.getHours();

  let periodo;
  if (hora < 12) periodo = 'manh√£';
  else if (hora < 18) periodo = 'tarde';
  else periodo = 'noite';

  tipsIndicator.textContent =
    'DICAS: Ciclo gerado para o per√≠odo atual (' + periodo.toUpperCase() + ').';

  const latInfo = geoLat != null ? geoLat.toFixed(2) : 'lat n√£o definida';
  const lngInfo = geoLng != null ? geoLng.toFixed(2) : 'lng n√£o definida';

  const dicas = [
    {
      titulo: 'Manh√£ ‚Äî Corpo & Painel',
      texto:
        'Alongar ombros e coluna por 3 minutos olhando para a luz natural. ' +
        'Checar mentalmente: ‚Äúmeu corpo est√° recebendo luz como o telhado recebe o sol?‚Äù. ' +
        'Se poss√≠vel, abrir uma janela e imaginar os pain√©is carregando junto com voc√™.',
    },
    {
      titulo: 'Tarde ‚Äî Foco & Processamento',
      texto:
        'Escolher uma tarefa importante e execut√°-la em bloco de 25 minutos. ' +
        'Pensar nos micro data centers locais: processar o que √© essencial agora, ' +
        'deixar o resto para outro ciclo. Menos abas abertas, mais qualidade de energia mental.',
    },
    {
      titulo: 'Noite ‚Äî Descarregar & Armazenar',
      texto:
        'Reduzir luz forte 1h antes de dormir. Registrar em 3 linhas o que voc√™ ‚Äúcarregou‚Äù hoje: ' +
        'aprendizados, decis√µes, sensa√ß√µes. Assim como a bateria do sistema solar, ' +
        'voc√™ armazena o essencial para o dia seguinte sem sobrecarregar o corpo.',
    }
  ];

  container.innerHTML = '';

  dicas.forEach(function(d) {
    const div = document.createElement('div');
    div.className = 'tip-block';
    div.innerHTML =
      '<strong>' + d.titulo + '</strong>' +
      '<span>' + d.texto + '</span>';
    container.appendChild(div);
  });

  const extra = document.createElement('p');
  extra.style.marginTop = '8px';
  extra.style.fontSize = '0.78rem';
  extra.style.color = 'var(--muted)';
  extra.textContent =
    'Geo base simb√≥lica atual: ' + latInfo + ' / ' + lngInfo +
    ' ¬∑ corpo humano e corpo da rede aprendendo juntos.';
  container.appendChild(extra);

  nvStopLoading();
}

/* GERADOR DE TEMPLATES LIVRO VIVO + TTS */
function nvGenerateTemplate(tipo) {
  nvStartLoading();
  const ta = document.getElementById('nv-template-output');
  if (!ta) {
    nvStopLoading();
    return;
  }

  let md = '';

  if (tipo === 'basico') {
    md = [
      '# ‚òÄÔ∏è Projeto Solar B√°sico ‚Äî Nos.S¬∞lar ¬∑ dual.infodose',
      '',
      '::info',
      'Proposta inicial de micro-usina solar conectada √† camada simb√≥lica do Nos.S¬∞lar.',
      'Este documento pode ser expandido no InfoDocs / Livro Vivo.',
      '::',
      '',
      '## üéØ Objetivo',
      '- Reduzir custos de energia;',
      '- Criar base para micro data center local;',
      '- Conectar o im√≥vel √† rede simb√≥lica Nos.S¬∞lar.',
      '',
      '## üìç Local & Perfil de Consumo',
      '- Endere√ßo / Bairro:',
      '- Consumo m√©dio (kWh/m√™s):',
      '- Telhado dispon√≠vel (m¬≤) / orienta√ß√£o:',
      '',
      '## ‚öôÔ∏è Dimensionamento Inicial',
      '- Pot√™ncia estimada (kWp):',
      '- N¬∫ de m√≥dulos:',
      '- Inversor / microinversores:',
      '',
      '## ü§ù Modelo de Parceria',
      '- Tipo: Equity / Servi√ßo / H√≠brido;',
      '- Participa√ß√£o proposta;',
      '- Benef√≠cios para o cliente;',
      '- Benef√≠cios para a rede Nos.S¬∞lar.',
      '',
      '## üì° Camada Digital & Simb√≥lica',
      '- Integra√ß√£o com painel Nos.S¬∞lar;',
      '- Monitoramento simb√≥lico (estado solar, dicas);',
      '- Rotina 3¬∑6¬∑9 de revis√£o energ√©tica.',
      ''
    ].join('\\n');
  } else if (tipo === 'escola') {
    md = [
      '# üè´ Educa√ß√£o Solar em Escolas ‚Äî Nos.S¬∞lar ¬∑ dual.infodose',
      '',
      '::info',
      'Documento-modelo para projetos de educa√ß√£o solar em escolas,',
      'conectando energia, tecnologia e forma√ß√£o de estudantes.',
      '::',
      '',
      '## üéØ Objetivos do Programa',
      '- Ensinar fundamentos de energia solar;',
      '- Integrar laborat√≥rio vivo (telhado da escola);',
      '- Conectar trilhas 3¬∑6¬∑9 de forma√ß√£o (alunos, professores, comunidade).',
      '',
      '## üß© Componentes do Projeto',
      '- Instala√ß√£o de sistema fotovoltaico (mini-usina);',
      '- Painel Nos.S¬∞lar na escola (visualiza√ß√£o em tempo real);',
      '- Atividades did√°ticas (experimentos, desafios, jogos).',
      '',
      '## üìö Trilhas 3¬∑6¬∑9',
      '- 3 encontros introdut√≥rios (energia, sol, comunidade);',
      '- 6 encontros pr√°ticos (medi√ß√£o, dados, projeto);',
      '- 9 atividades abertas (feiras, apresenta√ß√µes, mentorias).',
      '',
      '## ü§ù Parcerias',
      '- Empresa de solar / Parque Tecnol√≥gico;',
      '- Secretaria de Educa√ß√£o / Prefeitura;',
      '- Comunidade local / associa√ß√µes.',
      '',
      '## üîÅ Monitoramento & Expans√£o',
      '- M√©tricas de aprendizado;',
      '- Economia de energia;',
      '- Rotas para expans√£o a outros bairros / escolas.',
      ''
    ].join('\\n');
  } else if (tipo === 'parque') {
    md = [
      '# üè≠ Parque Tecnol√≥gico & Micro Data Center Solar ‚Äî Nos.S¬∞lar',
      '',
      '::info',
      'Modelo de documento para integrar parque tecnol√≥gico, empresas residentes e',
      'micro data centers alimentados por energia solar distribu√≠da.',
      '::',
      '',
      '## üéØ Vis√£o Geral',
      '- Transformar o parque em n√≥ central da rede Nos.S¬∞lar;',
      '- Alojar micro data centers dedicados a IA / servi√ßos digitais;',
      '- Construir spin-off cooperativa com empresas parceiras.',
      '',
      '## üß± Componentes de Infraestrutura',
      '- Telhados e √°reas dispon√≠veis para pain√©is;',
      '- Sala t√©cnica / cont√™iner de dados (micro data center);',
      '- Conectividade (fibra, redund√¢ncia, monitoramento).',
      '',
      '## ü§ù Modelo de Participa√ß√£o (Equity / Receita)',
      '- Percentual de participa√ß√£o por empresa;',
      '- Regras de entrada / sa√≠da;',
      '- Uso da marca ‚ÄúNos.S¬∞lar ‚Äî dual.infodose";',
      '- Mecanismos de reinvestimento no pr√≥prio parque.',
      '',
      '## üîß Stack Digital & Simb√≥lica',
      '- Pain√©is web / apps m√≥veis (como este Nos.S¬∞lar);',
      '- Monitoramento de energia + uso de servidores;',
      '- Integra√ß√£o com Livro Vivo / InfoDocs para documenta√ß√£o cont√≠nua.',
      '',
      '## üî≠ Roadmap 5‚Äì10 anos',
      '- Expans√£o para bairros e cidades vizinhas;',
      '- Parcerias com iniciativas africanas (Afrikafuturo);',
      '- Conex√£o com hubs solares globais.',
      ''
    ].join('\\n');
  }

  ta.value = md;

  try {
    localStorage.setItem('nossolar_last_template', md);
  } catch(e) {}

  nvStopLoading();
}

/* TTS b√°sico de boas-vindas */
let nvTtsInitDone = false;
let nvVoices = [];

function nvInitVoices() {
  if (!('speechSynthesis' in window)) return;
  nvVoices = window.speechSynthesis.getVoices() || [];
  nvTtsInitDone = true;
}

if ('speechSynthesis' in window) {
  window.speechSynthesis.onvoiceschanged = function() {
    nvInitVoices();
  };
  nvInitVoices();
}

function nvPickPtBrVoice() {
  if (!nvVoices || !nvVoices.length) return null;
  // Procura vozes PT-BR primeiro
  let pt = nvVoices.find(v =>
    /pt[-_]?BR/i.test(v.lang || '') ||
    /portuguese.*brazil/i.test((v.name || '') + ' ' + (v.lang || ''))
  );
  if (pt) return pt;
  // fallback para qualquer PT
  pt = nvVoices.find(v => /^pt[-_]/i.test(v.lang || ''));
  if (pt) return pt;
  return nvVoices[0] || null;
}

function nvSpeakWelcome() {
  const text =
    'Bem-vindo ao painel Nos Solar, dual Infodose. ' +
    'Aqui voc√™ conecta energia, dados e livro vivo em um s√≥ lugar. ' +
    'Gere um template, leve para o InfoDocs e continue o fluxo do seu projeto solar.';

  if (!('speechSynthesis' in window)) {
    alert(text);
    return;
  }

  const utter = new SpeechSynthesisUtterance(text);
  const voice = nvPickPtBrVoice();
  if (voice) utter.voice = voice;
  utter.rate = 1.02;
  utter.pitch = 1.0;
  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(utter);
}

/* LS STATUS interno do Nos.S¬∞lar */
function nvLsScan() {
  nvStartLoading();
  const out = document.getElementById('nv-ls-output');
  if (!out) {
    nvStopLoading();
    return;
  }

  try {
    const ls = window.localStorage;
    const len = ls.length;
    let totalBytes = 0;
    let lines = [];

    for (let i = 0; i < len; i++) {
      const key = ls.key(i);
      const val = ls.getItem(key);
      const size = (key.length + (val ? val.length : 0)) * 2; // aprox bytes
      totalBytes += size;
      lines.push('- ' + key + '  ~  ' + size + ' bytes aprox.');
    }

    const header =
      'Chaves armazenadas: ' + len + '\\n' +
      'Tamanho aproximado total: ' + totalBytes + ' bytes\\n';

    out.textContent = header + (lines.length ? '\\n' + lines.join('\\n') : '\\n(nenhuma chave encontrada)');
  } catch (e) {
    out.textContent = 'Erro ao ler localStorage: ' + e;
  }

  nvStopLoading();
}

function nvLsClear() {
  const out = document.getElementById('nv-ls-output');
  if (!out) return;
  if (!window.confirm('Deseja limpar as chaves do Nos.S¬∞lar neste navegador?')) return;

  nvStartLoading();
  try {
    const ls = window.localStorage;
    // Limpa apenas chaves com prefixo nossolar_
    const toRemove = [];
    for (let i = 0; i < ls.length; i++) {
      const key = ls.key(i);
      if (key && key.indexOf('nossolar_') === 0) {
        toRemove.push(key);
      }
    }
    toRemove.forEach(k => ls.removeItem(k));

    out.textContent =
      'Chaves com prefixo "nossolar_" removidas. ' +
      'Use "Ver estado atual do LS" para conferir.';
  } catch (e) {
    out.textContent = 'Erro ao limpar localStorage: ' + e;
  }
  nvStopLoading();
}
</script>
</body>
</html>
