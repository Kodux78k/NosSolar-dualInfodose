<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>N√ìS.S¬∞LAR ¬∑ N√≥ Solar Infodose</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#03040a" />

  <!-- PWA / MANIFEST / ICONS -->
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/icons/icon-512.png">
  <link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192.png">

  <style>
  /* MOBILE-FIRST VERTICAL HARD-LOCK ¬∑ NOSSO LAR + N√ì SOLAR FUSION */
  :root {
    --bg-0: #05050c;
    --nebula-1: #2b0b3f;
    --nebula-2: #0b3f6f;
    --madeira: #00ffc8;
    --gold: #f3c766;
    --text-main: #f5f5f7;
    --text-soft: #c6c6d0;
    --card-bg: rgba(6, 10, 22, 0.88);
    --radius-lg: 24px;
    --radius-pill: 999px;
    --shadow-soft: 0 18px 60px rgba(0,0,0,0.55);
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  html, body {
    width: 100%;
    height: 100%;
    overflow-x: hidden;
  }

  body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
    color: var(--text-main);
    background: radial-gradient(circle at top, var(--nebula-1), #05050c 40%),
                radial-gradient(circle at bottom, var(--nebula-2), #05050c 40%);
    display: flex;
    justify-content: center;
  }

  .app {
    width: 100%;
    max-width: 480px;
    min-height: 100vh;
    padding: 16px 16px 32px;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  header {
    padding: 12px 16px;
    border-radius: var(--radius-lg);
    background: linear-gradient(135deg, rgba(0,0,0,0.6), rgba(12,18,32,0.85));
    border: 1px solid rgba(243, 199, 102, 0.35);
    box-shadow: var(--shadow-soft);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .brand {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .brand-icon {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: radial-gradient(circle at 30% 20%, #fff8dd, var(--gold));
    box-shadow: 0 0 22px rgba(243, 199, 102, 0.8);
    position: relative;
  }

  .brand-icon::after {
    content: "";
    position: absolute;
    inset: 8px 6px 4px 6px;
    border-radius: 999px 999px 40px 40px;
    border: 2px solid rgba(12,8,2,0.9);
  }

  .brand-text {
    display: flex;
    flex-direction: column;
  }

  .brand-text span:nth-child(1) {
    font-size: 0.82rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--text-soft);
  }

  .brand-text span:nth-child(2) {
    font-size: 1.02rem;
    font-weight: 600;
  }

  .pill {
    padding: 6px 12px;
    border-radius: var(--radius-pill);
    border: 1px solid rgba(0,255,200,0.6);
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--madeira);
    background: rgba(0, 20, 15, 0.6);
  }

  main {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .hero {
    padding: 18px 16px 22px;
    border-radius: 28px;
    background: radial-gradient(circle at top, rgba(243,199,102,0.12), rgba(0,0,0,0.9));
    border: 1px solid rgba(243, 199, 102, 0.35);
    box-shadow: var(--shadow-soft);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px;
  }

  .hero-logo {
    width: 220px;
    height: 220px;
    border-radius: 50%;
    background: radial-gradient(circle at 25% 20%, #fff5da, var(--gold));
    position: relative;
    overflow: hidden;
  }

  .hero-logo::before {
    content: "";
    position: absolute;
    inset: 24px 30px 50px;
    border-radius: 999px 999px 60px 60px;
    background: rgba(10, 5, 0, 0.9);
    box-shadow: 0 0 60px rgba(0,0,0,0.9);
  }

  .hero-logo::after {
    content: "";
    position: absolute;
    inset: 72px 80px 72px 80px;
    border-radius: 999px;
    background: var(--gold);
    box-shadow: 0 0 45px rgba(243,199,102,0.9);
  }

  .hero-title {
    text-align: center;
    font-size: 1.15rem;
    font-weight: 600;
  }

  .hero-sub {
    text-align: center;
    font-size: 0.9rem;
    color: var(--text-soft);
  }

  .hero-actions {
    display: flex;
    flex-direction: column;
    gap: 8px;
    width: 100%;
    margin-top: 8px;
  }

  .btn-main {
    border-radius: var(--radius-pill);
    border: none;
    padding: 13px 18px;
    font-size: 0.95rem;
    font-weight: 600;
    color: #05050c;
    background: linear-gradient(135deg, var(--gold), #ffe9a0);
    box-shadow: 0 18px 40px rgba(0,0,0,0.6);
  }

  .btn-ghost {
    border-radius: var(--radius-pill);
    border: 1px solid rgba(243,199,102,0.6);
    padding: 11px 16px;
    font-size: 0.88rem;
    color: var(--text-main);
    background: rgba(0,0,0,0.35);
  }

  .tabs {
    display:flex;
    flex-wrap:nowrap;
    overflow-x:auto;
    gap:8px;
    padding:4px 0 2px;
  }
  .tab-btn {
    border-radius: var(--radius-pill);
    border:1px solid rgba(255,255,255,0.12);
    padding:7px 12px;
    font-size:0.74rem;
    color:var(--text-soft);
    background:rgba(0,0,0,0.45);
    white-space:nowrap;
  }
  .tab-btn.active {
    border-color: var(--madeira);
    color:var(--madeira);
    background:rgba(0,40,30,0.8);
  }

  .grid {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 10px;
  }

  .grid-row {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .card {
    flex: 1;
    border-radius: 22px;
    background: var(--card-bg);
    border: 1px solid rgba(255,255,255,0.08);
    padding: 12px 14px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.55);
  }

  .card-title {
    font-size: 0.95rem;
    font-weight: 600;
    margin-bottom: 4px;
    display:flex;
    align-items:center;
    gap:8px;
  }

  .card-sub {
    font-size: 0.8rem;
    color: var(--text-soft);
  }

  .chip {
    display:inline-block;
    margin-top:4px;
    padding:3px 8px;
    border-radius:999px;
    border:1px solid rgba(0,255,200,0.5);
    font-size:0.72rem;
    color:var(--madeira);
  }

  .card-header {
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:6px;
  }
  .card-tag {
    font-size:0.7rem;
    padding:3px 8px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,0.15);
    color:var(--text-soft);
  }
  .action {
    border-radius: var(--radius-pill);
    border:none;
    padding:8px 12px;
    font-size:0.78rem;
    background:rgba(0,255,200,0.12);
    color:var(--madeira);
  }

  footer {
    margin-top: 4px;
    font-size: 0.7rem;
    text-align: center;
    color: var(--text-soft);
    opacity: 0.7;
  }

  @media (min-width: 560px) {
    .grid-row {
      flex-direction: row;
    }
  }

  .icon {
    width:18px;
    height:18px;
    stroke:#00ffc8;
    stroke-width:1.7;
    fill:none;
  }
  .icon-gold {
    stroke:var(--gold);
  }

  /* OVERLAY / PAINEL DE ATIVA√á√ÉO */
  .overlay {
    position:fixed;
    inset:0;
    display:none;
    align-items:flex-end;
    justify-content:center;
    z-index:20;
  }
  .overlay.show {
    display:flex;
  }
  .overlay-backdrop {
    position:absolute;
    inset:0;
    background:rgba(0,0,0,0.6);
  }
  .overlay-panel {
    position:relative;
    width:100%;
    max-width:480px;
    max-height:90vh;
    background:radial-gradient(circle at top,#121525,#04040a);
    border-radius:26px 26px 0 0;
    border:1px solid rgba(243,199,102,0.45);
    box-shadow:0 -20px 50px rgba(0,0,0,0.8);
    padding:14px 16px 18px;
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .overlay-header {
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
  }
  .overlay-title {
    font-size:0.96rem;
    font-weight:600;
  }
  .overlay-sub {
    font-size:0.75rem;
    color:var(--text-soft);
  }
  .overlay-close {
    border:none;
    background:rgba(0,0,0,0.4);
    border-radius:999px;
    padding:4px 10px;
    font-size:0.8rem;
    color:var(--text-soft);
  }
  .overlay-body {
    margin-top:4px;
    overflow-y:auto;
    -webkit-overflow-scrolling: touch;
    padding-right:2px;
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .field-label {
    font-size:0.75rem;
    margin-bottom:2px;
  }
  .field-input,
  .field-textarea {
    width:100%;
    margin-top:2px;
    padding:6px 8px;
    border-radius:10px;
    border:none;
    outline:none;
    font-size:0.8rem;
    background:rgba(0,0,0,0.4);
    color:var(--text-main);
  }
  .field-textarea {
    resize:vertical;
  }
  .locais-row {
    display:flex;
    flex-direction:column;
    gap:6px;
    padding:8px;
    border-radius:14px;
    background:rgba(0,0,0,0.35);
    border:1px solid rgba(255,255,255,0.08);
    margin-bottom:6px;
  }
  .locais-row-header {
    display:flex;
    justify-content:space-between;
    align-items:center;
    font-size:0.78rem;
  }
  .tiny {
    font-size:0.7rem;
    color:var(--text-soft);
  }
  .btn-small {
    border-radius:999px;
    border:none;
    padding:4px 9px;
    font-size:0.72rem;
    background:rgba(0,255,200,0.14);
    color:var(--madeira);
  }
  .btn-share {
    background:linear-gradient(135deg,#00ffc8,#f3c766);
    color:#03040a;
  }
  .result-box {
    margin-top:4px;
    padding:8px;
    border-radius:12px;
    background:rgba(0,0,0,0.45);
    font-size:0.75rem;
    white-space:pre-wrap;
  }

  /* LOADER GEO */
  .loader {
    width: 26px;
    height: 26px;
    border-radius: 999px;
    border: 3px solid rgba(0, 255, 200, 0.15);
    border-top-color: var(--gold);
    animation: spin 0.9s linear infinite;
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  /* GLOBO / ORBE SOLAR AFRIKAFUTURO */
  .solar-orb-wrap {
    display:flex;
    flex-direction:column;
    align-items:center;
    margin:4px 0 6px;
  }
  .solar-orb {
    width:82px;
    height:82px;
    border-radius:50%;
    background:radial-gradient(circle at 30% 20%, #fff6cf, #f3c766 38%, #26153b 80%);
    position:relative;
    box-shadow:0 0 26px rgba(243,199,102,0.65);
    overflow:hidden;
  }
  .solar-orb::before {
    content:"";
    position:absolute;
    inset:10px;
    border-radius:50%;
    box-shadow:inset 0 0 14px rgba(0,0,0,0.85);
  }
  .solar-orb::after {
    content:"";
    position:absolute;
    width:14px;
    height:14px;
    border-radius:50%;
    background:#ffe08a;
    top:50%;
    left:50%;
    transform-origin:-26px -26px;
    animation:orbital 4s linear infinite;
    box-shadow:0 0 14px rgba(255,223,150,0.95);
  }
  .solar-orb-oca {
    position:absolute;
    inset:18px;
  }
  .solar-orb-oca path {
    fill:none;
    stroke:#261208;
    stroke-width:2.2;
    stroke-linecap:round;
    stroke-linejoin:round;
  }

  @keyframes orbital {
    to { transform: rotate(360deg); }
  }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <div class="brand-icon"></div>
        <div class="brand-text">
          <span>N√ìS.S¬∞LAR ¬∑ N√ì SOLAR</span>
          <span>Nosso Lar ¬∑ Parque ¬∑ Afrikafuturo</span>
        </div>
      </div>
      <div class="pill">mvp ¬∑ hub solar</div>
    </header>

    <main>
      <!-- HERO PRINCIPAL -->
      <section class="hero">
        <div class="hero-logo" id="logo-slot"></div>
        <div class="hero-title">Um lar que respira Sol. Uma cidade que acende a mente.</div>
        <div class="hero-sub">
          Conecte o seu lar, o Parque Tecnol√≥gico, a usina solar e o Blueprint Afrikafuturo:
          emprego, neg√≥cios, educa√ß√£o e servidores solares urbanos.
        </div>
        <div class="hero-actions">
          <button class="btn-main" id="btn-ativar">Ativar Nosso Lar / N√≥ Solar</button>
          <button class="btn-ghost" id="btn-modo-ritual">Entrar em modo ritual solar</button>
        </div>
      </section>

      <!-- ABAS / TABS -->
      <section class="tabs" id="tabs">
        <button class="tab-btn active" data-tab="visao">Vis√£o Geral</button>
        <button class="tab-btn" data-tab="parque">Parque & Usina</button>
        <button class="tab-btn" data-tab="energia">Energia & Emprego</button>
        <button class="tab-btn" data-tab="empreender">Empreender Solar</button>
        <button class="tab-btn" data-tab="educacao">Educa√ß√£o & Telhados</button>
        <button class="tab-btn" data-tab="bairro">Com√©rcio & Bairro Solar</button>
        <button class="tab-btn" data-tab="servidores">Servidores & Afrikafuturo</button>
      </section>

      <!-- HUB DE CONTE√öDO MUT√ÅVEL -->
      <section class="grid" id="hub"></section>
    </main>

    <footer>
      N√ìS.S¬∞LAR ¬∑ N√≥ Solar Infodose ¬∑ Kodux ‚Äî prot√≥tipo vivo (MVP unificado)
    </footer>
  </div>

  <!-- OVERLAY: PERFIL + REDE SOLAR + MD + SHARE -->
  <div class="overlay" id="overlay-solar">
    <div class="overlay-backdrop" onclick="closeSolarOverlay()"></div>
    <div class="overlay-panel">
      <div class="overlay-header">
        <div>
          <div class="overlay-title">N√≥ Solar do Seu Lar</div>
          <div class="overlay-sub">Perfil ¬∑ Rede Solar ¬∑ Servidor ¬∑ Compartilhar</div>
        </div>
        <button class="overlay-close" onclick="closeSolarOverlay()">fechar</button>
      </div>

      <div class="overlay-body">
        <!-- PERFIL -->
        <section class="card">
          <div class="card-header">
            <div class="card-title">Perfil do Lar</div>
            <div class="card-tag">config</div>
          </div>
          <p class="tiny">
            S√≥ precisa informar <strong>seu nome</strong> e <strong>WhatsApp</strong>.<br>
            Assistente, cidade e inten√ß√£o s√£o opcionais. Tudo fica salvo no aparelho (localStorage).
          </p>

          <div style="display:flex;flex-direction:column;gap:6px;margin-top:6px;">
            <div>
              <div class="field-label">Seu nome</div>
              <input id="perfilNome" class="field-input" type="text" placeholder="Seu nome">
            </div>

            <div>
              <div class="field-label">WhatsApp</div>
              <input id="perfilWhatsapp" class="field-input" type="tel" placeholder="(11) 9 9999-9999">
            </div>

            <div>
              <div class="field-label">Nome do assistente</div>
              <input id="perfilAssistente" class="field-input" type="text" placeholder="Ex: Nosso Lar, N√≥ Solar, Alumini...">
            </div>
            <div>
              <div class="field-label">Cidade / Regi√£o</div>
              <input id="perfilCidade" class="field-input" type="text" placeholder="Cidade / bairro">
            </div>
            <div>
              <div class="field-label">Inten√ß√£o do Lar</div>
              <textarea id="perfilIntencao" class="field-textarea" rows="2"
                placeholder="Ex: Cuidar melhor da casa, da mente e da energia."></textarea>
            </div>
          </div>

          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">
            <button class="action" onclick="saveProfile()">salvar perfil</button>
            <button class="action btn-share" onclick="exportProfileJson()">exportar json infodose</button>
          </div>

          <details style="margin-top:6px;font-size:0.75rem;opacity:0.9;">
            <summary>Ver JSON atual</summary>
            <pre id="perfilJsonView" style="margin-top:4px;font-size:0.7rem;white-space:pre-wrap;"></pre>
          </details>
        </section>

        <!-- REDE SOLAR & SERVIDORES (COM GLOBO ANIMADO + SANFONAS) -->
        <section class="card">
          <div class="card-header">
            <div class="card-title">Rede Solar & Servidores</div>
            <div class="card-tag">c√°lculo simb√≥lico</div>
          </div>
          <div class="solar-orb-wrap">
            <div class="solar-orb">
              <svg class="solar-orb-oca" viewBox="0 0 64 64">
                <path d="M12 32 L32 16 L52 32" />
                <path d="M16 32 L16 46 L48 46 L48 32" />
                <path d="M26 46 L26 36 L38 36 L38 46" />
              </svg>
            </div>
            <div class="tiny" style="text-align:center;margin-top:4px;">
              Globo-N√≥ Afrikafuturo: sua regi√£o vista como ponto solar.
            </div>
          </div>

          <p class="tiny">
            Clique para o app estimar o Sol da sua regi√£o, o tamanho do sistema
            e quantos mini-servidores solares cabem simbolicamente no seu territ√≥rio.
          </p>

          <button class="action" style="margin-top:8px;width:100%;" onclick="startGeoActivation()">
            analisar minha regi√£o pelo Sol
          </button>
          <div class="tiny" style="margin-top:4px;text-align:center;">
            Ao clicar, o app pede sua localiza√ß√£o uma vez e salva o resultado abaixo.
          </div>

          <div id="solarAutoBox" class="result-box" style="display:none;margin-top:8px;">
            <!-- preenchido via JS -->
          </div>
          <button class="btn-small" style="margin-top:4px;" onclick="copyElementText('solarAutoBox')">
            copiar an√°lise solar
          </button>

          <div style="margin-top:10px;">
            <div class="field-label">Custo m√©dio por kWp instalado (R$)</div>
            <input id="inputCustoKwp" class="field-input" type="number" value="5000" min="1000" step="100">
            <div class="tiny">Valor gen√©rico (ajust√°vel). Ex: R$ 4.000‚Äì6.000 / kWp.</div>
          </div>

          <div style="margin-top:8px;">
            <div class="locais-row-header">
              <span class="tiny">Locais na rede</span>
              <button class="btn-small" onclick="addLocal()">+ adicionar local</button>
            </div>
            <div id="locaisContainer"></div>
          </div>

          <button class="action" style="margin-top:4px;" onclick="calcularRedeSolar()">
            calcular rede solar
          </button>

          <div id="resultadoRede" class="result-box" style="display:none;"></div>
          <button class="btn-small" style="margin-top:4px;" onclick="copyElementText('resultadoRede')">
            copiar resumo da rede
          </button>
        </section>

        <!-- BLOCOS MD -->
        <section class="card">
          <div class="card-header">
            <div class="card-title">Blocos MD ¬∑ N√≥ & Servidor Solar</div>
            <div class="card-tag">md</div>
          </div>
          <p class="tiny">
            Copie estes blocos em Markdown e cole em qualquer IA ou editor para explicar o N√ìS.S¬∞LAR
            e a ideia de servidores solares independentes de nuvenzona.
          </p>

          <!-- BLOCO 1 ‚Äî VIS√ÉO GERAL -->
          <pre id="md-nosslar-basico" style="margin-top:6px;font-size:0.75rem;white-space:pre-wrap;background:rgba(0,0,0,0.5);padding:8px;border-radius:10px;">
# N√ìS.S¬∞LAR ¬∑ Nosso Lar  
Um hub solar-vivo que conecta lares, bairros, parque tecnol√≥gico e Afrikafuturo.  
Cada casa vira um n√≥: energia fotovoltaica, mini-servidores, rotinas de cuidado e rede de apoio local.  

- Perfil do lar salvo localmente (nome, assistente, cidade, inten√ß√£o)  
- Simula√ß√£o simb√≥lica de sistema solar (custo, payback, servidores poss√≠veis)  
- Expans√£o em rede: quanto mais lares conectados, menor o custo m√©dio e maior o ganho coletivo.  
          </pre>

          <button class="action" style="margin-top:4px;" onclick="copyMarkdownBlock('md-nosslar-basico')">
            copiar md vis√£o geral
          </button>

          <!-- BLOCO 2 ‚Äî SERVIDOR SOLAR / NUVEM LOCAL -->
          <pre id="md-nosslar-servidor" style="margin-top:8px;font-size:0.75rem;white-space:pre-wrap;background:rgba(0,0,0,0.5);padding:8px;border-radius:10px;">
## Servidores solares urbanos ¬∑ Menos Amazon, mais bairro  

O N√ìS.S¬∞LAR calcula o potencial solar da regi√£o a partir da localiza√ß√£o (lat/long)  
e converte isso em capacidade digital local:  

- Mini-servidores solares (~100W) alimentados diretamente pelos pain√©is  
- Armazenamento distribu√≠do de fotos e v√≠deos da comunidade  
- Streaming local (aulas, cultos, eventos, Infodose) sem depender s√≥ de nuvem externa  
- Conex√µes simult√¢neas suficientes para um ‚Äúpequeno data center de bairro‚Äù  

Parte da energia solar que hoje iria apenas para a conta de luz  
pode ser reservada para rodar:  

- Servidores Infodose locais  
- Portais de bairro, hist√≥ricos de fotos, acervos culturais  
- Chats e aplica√ß√µes que ficam mais r√°pidos por estarem ‚Äúdentro do territ√≥rio‚Äù  

A ideia n√£o √© excluir a nuvem (Amazon, Google etc.),  
mas equilibrar: o bairro vira uma camada de nuvem pr√≥pria,  
alimentada pelo sol, mais perto das pessoas e da hist√≥ria delas.  
          </pre>

          <button class="action" style="margin-top:4px;" onclick="copyMarkdownBlock('md-nosslar-servidor')">
            copiar md servidores solares
          </button>
        </section>

        <!-- COMPARTILHAR -->
        <section class="card">
          <div class="card-header">
            <div class="card-title">Compartilhar N√≥ Solar</div>
            <div class="card-tag">rede</div>
          </div>
          <p class="tiny">
            Envie o link ou resumo do seu N√≥ Solar para amigos, vizinhos ou grupos.
            Quanto mais n√≥s, menor o custo m√©dio e maior a redistribui√ß√£o.
          </p>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px;">
            <button class="btn-small btn-share" onclick="shareNoSolar()">compartilhar agora</button>
          </div>
        </section>
      </div>
    </div>
  </div>

  <script>
  const log = (...args) => console.log("[NOS_SLAR_NOSOLAR]", ...args);
  const PROFILE_KEY = "nosSlarProfile";
  let lastLocation = null;
  let locaisIndex = 0;
  let localDetectadoCriado = false;

  function hasProfile() {
    try {
      return !!localStorage.getItem(PROFILE_KEY);
    } catch (e) {
      return false;
    }
  }

  // ---------------- INIT ----------------
  function initApp() {
    log("App iniciado.");
    wireMainButtons();
    wireTabs();
    setView("visao");
    loadProfile();
    registerServiceWorker();
    // local gen√©rico inicial (usu√°rio pode editar ou remover)
    addLocal("Casa", 350);
  }

  function registerServiceWorker() {
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("sw.js")
        .then(() => log("Service Worker registrado."))
        .catch(err => console.warn("SW erro:", err));
    }
  }

  // ---------------- BOT√ïES PRINCIPAIS / OVERLAY ----------------
  function wireMainButtons() {
    const ativar = document.getElementById("btn-ativar");
    const ritual = document.getElementById("btn-modo-ritual");
    if (ativar) {
      ativar.addEventListener("click", () => {
        openSolarOverlay();
      });
    }
    if (ritual) {
      ritual.addEventListener("click", () => {
        log("Modo Ritual Solar");
        alert("Modo Ritual iniciado.\nRespira, sente o espa√ßo, imagina o Sol percorrendo telhado, servidor e mente.");
      });
    }
  }

  function openSolarOverlay() {
    const overlay = document.getElementById("overlay-solar");
    if (!overlay) return;
    overlay.classList.add("show");
    // Geolocaliza√ß√£o agora s√≥ roda quando clicar em "analisar minha regi√£o pelo Sol"
  }

  function closeSolarOverlay() {
    const overlay = document.getElementById("overlay-solar");
    if (!overlay) return;
    overlay.classList.remove("show");
  }

  function startGeoActivation() {
    const box = document.getElementById("solarAutoBox");
    if (box) {
      box.style.display = "block";
      box.innerHTML = `
        <div style="display:flex;align-items:center;gap:8px;">
          <div class="loader"></div>
          <div class="tiny">
            Buscando seu Sol e calculando o potencial da sua regi√£o...
          </div>
        </div>
      `;
    }
    askLocationOnce();
  }

  // ---------------- VIEWS / TABS ----------------
  const hub = document.getElementById("hub");

  const views = {
    visao: `
      <div class="grid-row">
        <article class="card">
          <div class="card-title">
            <svg class="icon icon-gold" viewBox="0 0 24 24">
              <circle cx="12" cy="12" r="4"></circle>
              <g stroke-linecap="round">
                <line x1="12" y1="2" x2="12" y2="5"/>
                <line x1="12" y1="19" x2="12" y2="22"/>
                <line x1="2" y1="12" x2="5" y2="12"/>
                <line x1="19" y1="12" x2="22" y2="12"/>
              </g>
            </svg>
            Um Ponto Solar
          </div>
          <div class="card-sub">
            O n√∫cleo que conecta energia, servidor, comunica√ß√£o e comunidade.
            <div class="chip">Energia ¬∑ Servidor</div>
          </div>
        </article>
        <article class="card">
          <div class="card-title">
            <svg class="icon" viewBox="0 0 24 24">
              <path d="M4 19v-6a8 8 0 0 1 16 0v6" />
              <circle cx="12" cy="9" r="3" />
            </svg>
            N√≥ de Capacita√ß√£o
          </div>
          <div class="card-sub">
            Treinamentos Infodose para que qualquer pessoa esteja pronta em dias, n√£o em meses.
            <div class="chip">Forma√ß√£o 24‚Äì72h</div>
          </div>
        </article>
      </div>
      <div class="grid-row">
        <article class="card">
          <div class="card-title">
            <svg class="icon" viewBox="0 0 24 24">
              <circle cx="12" cy="7" r="3"/>
              <path d="M4 21c1-3 4-5 8-5s7 2 8 5"/>
            </svg>
            Hub de M√£o de Obra Treinada
          </div>
          <div class="card-sub">
            Um lugar digital onde empresas encontram trabalhadores prontos, e trabalhadores encontram oportunidade.
            <div class="chip">Emprego local</div>
          </div>
        </article>
        <article class="card">
          <div class="card-title">
            <svg class="icon" viewBox="0 0 24 24">
              <circle cx="12" cy="12" r="3"/>
              <path d="M12 2v3M12 19v3M4 12H2M22 12h-2"/>
            </svg>
            Centro Simb√≥lico de Transforma√ß√£o
          </div>
          <div class="card-sub">
            A camada de significado: rituais, Afrikafuturo, dopamina sexy, espa√ßo da mente, 78K.
            <div class="chip">Blueprint Vivo</div>
          </div>
        </article>
      </div>
    `,
    parque: `
      <div class="grid-row">
        <article class="card">
          <div class="card-title">
            <svg class="icon" viewBox="0 0 24 24">
              <path d="M3 12h18M5 12v7h14v-7M9 12V7l3-3 3 3v5"/>
            </svg>
            Parque Tecnol√≥gico
          </div>
          <div class="card-sub">
            Polo de inova√ß√£o, empresas, laborat√≥rios, incubadoras e eventos tecnol√≥gicos.
            <div class="chip">Inova√ß√£o Sorocaba</div>
          </div>
        </article>
        <article class="card">
          <div class="card-title">
            <svg class="icon icon-gold" viewBox="0 0 24 24">
              <rect x="3" y="7" width="18" height="10" rx="3"/>
              <path d="M8 7V4h8v3"/>
            </svg>
            Usina Solar
          </div>
          <div class="card-sub">
            9.984 pain√©is, 10 GWh/ano. Um dos maiores rooftops solares do Estado, base f√≠sica do N√≥ Solar.
            <div class="chip">Infraestrutura real</div>
          </div>
        </article>
      </div>
      <div class="grid-row">
        <article class="card">
          <div class="card-title">
            <svg class="icon" viewBox="0 0 24 24">
              <path d="M6 20h12M8 16h8M10 12h4M12 2v5"/>
            </svg>
            Programas & Eventos
          </div>
          <div class="card-sub">
            Jornadas de inova√ß√£o, hackathons, eventos educacionais e feiras conectadas ao N√≥ Solar e √† Infodose.
            <div class="chip">Programas Abertos</div>
          </div>
        </article>
      </div>
    `,
    energia: `
      <div class="grid-row">
        <article class="card">
          <div class="card-title">
            <svg class="icon" viewBox="0 0 24 24">
              <path d="M13 2L3 14h7l-1 8L21 10h-7z"/>
            </svg>
            Energia & Emprego
          </div>
          <div class="card-sub">
            Trilha que ensina instala√ß√£o, manuten√ß√£o, diagn√≥stico e vendas de sistemas fotovoltaicos.
            <div class="chip">Trabalho Solar</div>
          </div>
        </article>
        <article class="card">
          <div class="card-title">
            <svg class="icon" viewBox="0 0 24 24">
              <path d="M4 4h16v6H4z"/>
              <path d="M6 10v7h12v-7"/>
            </svg>
            Hub de M√£o de Obra
          </div>
          <div class="card-sub">
            Painel onde empresas cadastram vagas e encontram pessoas j√° treinadas.
            <div class="chip">Match autom√°tico</div>
          </div>
        </article>
      </div>
    `,
    empreender: `
      <div class="grid-row">
        <article class="card">
          <div class="card-title">
            <svg class="icon" viewBox="0 0 24 24">
              <path d="M3 12l8-8 10 10-8 8z"/>
              <circle cx="12" cy="12" r="2"/>
            </svg>
            Empreender Solar
          </div>
          <div class="card-sub">
            Modelos prontos para oficinas, adegas, caf√©s, est√∫dios e servi√ßos rodando com energia solar.
            <div class="chip">Neg√≥cios locais</div>
          </div>
        </article>
        <article class="card">
          <div class="card-title">
            <svg class="icon" viewBox="0 0 24 24">
              <path d="M4 20V10l8-6 8 6v10"/>
              <path d="M9 21v-6h6v6"/>
            </svg>
            Nosso Lar Solar
          </div>
          <div class="card-sub">
            Cada casa como um micro-hub: energia, microservidor, rituais e conex√£o com o bairro.
            <div class="chip">N√ìS.S¬∞LAR</div>
          </div>
        </article>
      </div>
    `,
    educacao: `
      <div class="grid-row">
        <article class="card">
          <div class="card-title">
            <svg class="icon" viewBox="0 0 24 24">
              <path d="M4 7l8-4 8 4-8 4-8-4z"/>
              <path d="M6 10v5l6 3 6-3v-5"/>
            </svg>
            Educa√ß√£o Solar em Escolas
          </div>
          <div class="card-sub">
            Programas para alunos entenderem energia, clima, tecnologia e futuro Afrikafuturo.
            <div class="chip">Crian√ßas & Jovens</div>
          </div>
        </article>
        <article class="card">
          <div class="card-title">
            <svg class="icon icon-gold" viewBox="0 0 24 24">
              <rect x="2" y="8" width="20" height="12" rx="3"/>
              <path d="M6 8V5h12v3"/>
            </svg>
            Telhados P√∫blicos
          </div>
          <div class="card-sub">
            Invent√°rio de escolas, postos de sa√∫de, pr√©dios p√∫blicos e espa√ßos culturais para implanta√ß√£o solar.
            <div class="chip">Mapa Solar Urbano</div>
          </div>
        </article>
      </div>
    `,
    bairro: `
      <div class="grid-row">
        <article class="card">
          <div class="card-title">
            <svg class="icon" viewBox="0 0 24 24">
              <path d="M3 10h18M3 16h18M5 10v10M19 10v10"/>
            </svg>
            Com√©rcio Solar
          </div>
          <div class="card-sub">
            Lojas, mercados, padarias, bares e servi√ßos rodando com energia solar e suporte Infodose.
            <div class="chip">Economia real</div>
          </div>
        </article>
        <article class="card">
          <div class="card-title">
            <svg class="icon" viewBox="0 0 24 24">
              <path d="M3 12l3-3 3 3 3-3 3 3 3-3 3 3"/>
              <path d="M4 18h16"/>
            </svg>
            Bairro Solar
          </div>
          <div class="card-sub">
            Bairros-n√≥ que se organizam como pequenos ecossistemas, conectando lares, com√©rcios e servidores solares.
            <div class="chip">Bairros-N√≥</div>
          </div>
        </article>
      </div>
    `,
    servidores: `
      <div class="grid-row">
        <article class="card">
          <div class="card-title">
            <svg class="icon" viewBox="0 0 24 24">
              <rect x="3" y="4" width="18" height="7" rx="2"/>
              <rect x="3" y="13" width="18" height="7" rx="2"/>
              <circle cx="8" cy="7.5" r="0.8"/>
              <circle cx="8" cy="16.5" r="0.8"/>
            </svg>
            Servidores Solares Urbanos
          </div>
          <div class="card-sub">
            Micro data-centers distribu√≠dos em lares, com√©rcios e hubs, rodando Infodose e servi√ßos locais.
            <div class="chip">Edge Solar</div>
          </div>
        </article>
      </div>
      <div class="grid-row">
        <article class="card">
          <div class="card-title">
            <svg class="icon icon-gold" viewBox="0 0 24 24">
              <circle cx="12" cy="12" r="6"/>
              <path d="M12 2v3M12 19v3M4 12H2M22 12h-2"/>
            </svg>
            Blueprint Afrikafuturo Brasil
          </div>
          <div class="card-sub">
            Conex√£o com incubadoras africanas, hubs solares, projetos como Desert-to-Power e centros em Marrocos, Nam√≠bia, Nig√©ria e Qu√™nia.
            <div class="chip">Eixo Brasil‚Äì√Åfrica</div>
          </div>
        </article>
      </div>
    `
  };

  function setView(name){
    if(!views[name]) return;
    hub.innerHTML = views[name];
  }

  function wireTabs(){
    document.querySelectorAll(".tab-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        const tab = btn.getAttribute("data-tab");
        log("change_tab", tab);
        setView(tab);
      });
    });
  }

  // ---------------- PERFIL / LOCALSTORAGE ----------------
  function loadProfile() {
    try {
      const raw = localStorage.getItem(PROFILE_KEY);
      if (!raw) return;
      const data = JSON.parse(raw);
      if (data.nome) document.getElementById("perfilNome").value = data.nome;
      if (data.whatsapp) document.getElementById("perfilWhatsapp").value = data.whatsapp;
      if (data.assistente) document.getElementById("perfilAssistente").value = data.assistente;
      if (data.cidade) document.getElementById("perfilCidade").value = data.cidade;
      if (data.intencao) document.getElementById("perfilIntencao").value = data.intencao;
      updateProfileJsonView(data);
    } catch (e) {
      console.warn("Erro ao carregar perfil:", e);
    }
  }

  function saveProfile() {
    const nome = (document.getElementById("perfilNome").value || "").trim();
    const whatsapp = (document.getElementById("perfilWhatsapp").value || "").trim();

    if (!nome || !whatsapp) {
      alert("Coloca pelo menos seu nome e WhatsApp pra ativar o N√≥ Solar. üåû");
      return;
    }

    const data = {
      nome,
      whatsapp,
      assistente: (document.getElementById("perfilAssistente").value || "").trim(),
      cidade: (document.getElementById("perfilCidade").value || "").trim(),
      intencao: (document.getElementById("perfilIntencao").value || "").trim(),
      updatedAt: new Date().toISOString()
    };
    localStorage.setItem(PROFILE_KEY, JSON.stringify(data));
    updateProfileJsonView(data);
    alert("Perfil salvo no aparelho. ‚ú®");
  }

  function updateProfileJsonView(data) {
    const el = document.getElementById("perfilJsonView");
    if (!el) return;
    el.textContent = JSON.stringify(data, null, 2);
  }

  function exportProfileJson() {
    try {
      const raw = localStorage.getItem(PROFILE_KEY) || "{}";
      const data = JSON.parse(raw);
      const payload = {
        type: "infodose_profile",
        version: "1.0",
        symbol: "NOS_SLAR",
        profile: data,
        location: lastLocation
      };
      const json = JSON.stringify(payload, null, 2);

      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(json).then(() => {
          alert("JSON copiado! Cole direto na Infodose / IA. ‚ö°");
        }).catch(() => {
          downloadJsonFile(json);
        });
      } else {
        downloadJsonFile(json);
      }
    } catch (e) {
      console.warn("Erro ao exportar JSON:", e);
      alert("N√£o consegui exportar o JSON agora.");
    }
  }

  function downloadJsonFile(json) {
    const blob = new Blob([json], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "nos_slar_profile.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // ---------------- LOCAIS / REDE SOLAR ----------------
  function addLocal(nome = "", gasto = "") {
    const container = document.getElementById("locaisContainer");
    if (!container) return;
    const id = `local-${locaisIndex++}`;
    const div = document.createElement("div");
    div.className = "locais-row";
    div.dataset.localId = id;
    div.innerHTML = `
      <div class="locais-row-header">
        <span>${nome || "Local"} <span class="tiny">(casa, est√∫dio, escrit√≥rio...)</span></span>
        <button class="btn-small" onclick="removerLocal('${id}')">remover</button>
      </div>
      <div>
        <div class="field-label">Nome do local</div>
        <input class="field-input" type="text" placeholder="Ex: Casa Sorocaba, Est√∫dio, Escrit√≥rio"
               data-field="nome" value="${nome}">
      </div>
      <div>
        <div class="field-label">Gasto m√©dio mensal em energia (R$)</div>
        <input class="field-input" type="number" min="0" step="10" placeholder="Ex: 300"
               data-field="gasto" value="${gasto}">
      </div>
    `;
    container.appendChild(div);
  }

  function removerLocal(id) {
    const container = document.getElementById("locaisContainer");
    if (!container) return;
    const row = Array.from(container.children).find(el => el.dataset.localId === id);
    if (row) container.removeChild(row);
  }

  function calcularRedeSolar() {
    const container = document.getElementById("locaisContainer");
    const resultado = document.getElementById("resultadoRede");
    if (!container || !resultado) return;

    const custoKwp = parseFloat(document.getElementById("inputCustoKwp").value || "0") || 0;
    if (custoKwp <= 0) {
      alert("Defina um custo por kWp v√°lido.");
      return;
    }

    const locaisEls = Array.from(container.getElementsByClassName("locais-row"));
    if (locaisEls.length === 0) {
      alert("Adicione pelo menos um local.");
      return;
    }

    const tarifaKwh = 0.9;
    const kwhPorKwpMes = 120;

    const fotosPorServidor = 40000;
    const horasStreamingPorServidorMes = 200;
    const conexoesSimultaneasPorServidor = 40;

    let totalKwp = 0;
    let totalCustoBruto = 0;
    let totalConta = 0;
    let totalServidores = 0;

    let texto = "üìä Estimativa simb√≥lica da Rede Solar:\n\n";

    locaisEls.forEach((row, idx) => {
      const nomeInput = row.querySelector('input[data-field="nome"]');
      const gastoInput = row.querySelector('input[data-field="gasto"]');
      const nome = (nomeInput?.value || `Local ${idx + 1}`).trim();
      const gasto = parseFloat(gastoInput?.value || "0") || 0;

      const consumoKwhMes = gasto > 0 ? gasto / tarifaKwh : 0;
      const kwpNecessario = consumoKwhMes > 0 ? consumoKwhMes / kwhPorKwpMes : 0;
      const custoSistema = kwpNecessario * custoKwp;

      totalKwp += kwpNecessario;
      totalCustoBruto += custoSistema;
      totalConta += gasto;

      const kwhSolarMes = kwpNecessario * kwhPorKwpMes;
      const servidores = kwpNecessario > 0
        ? Math.floor(kwhSolarMes / 72)
        : 0;

      totalServidores += servidores;

      texto += `‚Ä¢ ${nome}  
  Conta atual ‚âà R$ ${gasto.toFixed(0)} / m√™s  
  Sistema estimado ‚âà ${kwpNecessario.toFixed(1)} kWp  
  Gera√ß√£o solar ‚âà ${kwhSolarMes.toFixed(0)} kWh/m√™s  
  Custo bruto ‚âà R$ ${custoSistema.toFixed(0)}  
  Mini-servidores solares ‚âà ${servidores} (100W cont√≠nuos)\n\n`;
    });

    const n = locaisEls.length;
    const fatorRede = Math.pow(0.9, Math.max(0, n - 1));
    const custoRede = totalCustoBruto * fatorRede;
    const economiaAnual = totalConta * 12;
    const paybackAnos = economiaAnual > 0 ? custoRede / economiaAnual : 0;

    const totalFotos = totalServidores * fotosPorServidor;
    const totalHorasVideo = totalServidores * horasStreamingPorServidorMes;
    const totalConexoes = totalServidores * conexoesSimultaneasPorServidor;

    texto += `üåê Rede com ${n} local(is)  
Custo bruto somado ‚âà R$ ${totalCustoBruto.toFixed(0)}  
Fator de rede (desconto simb√≥lico) ‚âà ${(fatorRede * 100).toFixed(0)}%  
Custo estimado em rede ‚âà R$ ${custoRede.toFixed(0)}  

üí∞ Economia estimada (se zerar a conta):  
‚âà R$ ${totalConta.toFixed(0)} / m√™s  
‚âà R$ ${economiaAnual.toFixed(0)} / ano  

‚è≥ Payback simb√≥lico ‚âà ${paybackAnos.toFixed(1)} anos  
(Quanto mais n√≥s na rede, mais esse n√∫mero tende a cair.)\n\n`;

    texto += `üíæ Capacidade digital local (estimada)  
Servidores solares poss√≠veis ‚âà ${totalServidores} n√≥s de 100W  

‚Ä¢ Armazenamento distribu√≠do ‚âà ${totalFotos.toLocaleString("pt-BR")} fotos de 5MB  
‚Ä¢ Streaming local ‚âà ${totalHorasVideo.toLocaleString("pt-BR")} horas de v√≠deo por m√™s  
‚Ä¢ Conex√µes simult√¢neas ‚âà ${totalConexoes.toLocaleString("pt-BR")} sess√µes (apps, chat, Infodose)  

Isso significa que uma parte das coisas que hoje iriam para a nuvem (ex: Amazon, Google, etc.)  
poderiam rodar em servidores solares espalhados nos lares e com√©rcios do seu bairro,  
com menor lat√™ncia, mais controle e mais sentido comunit√°rio.`;

    resultado.style.display = "block";
    resultado.textContent = texto;
  }

  // ---------------- BLOCO MD COPI√ÅVEL ----------------
  function copyMarkdownBlock(id) {
    const el = document.getElementById(id);
    if (!el) return alert("Bloco MD n√£o encontrado.");
    const text = el.textContent;
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text).then(() => {
        alert("Markdown copiado! Cole na IA ou em qualquer editor. üíä");
      }).catch(err => {
        console.warn("Erro ao copiar:", err);
        fallbackSelectText(el);
      });
    } else {
      fallbackSelectText(el);
    }
  }

  function fallbackSelectText(el) {
    const range = document.createRange();
    range.selectNodeContents(el);
    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);
    alert("Texto selecionado. Agora toque em copiar no seu aparelho. üìã");
  }

  // Gen√©rico: copiar qualquer container de resposta (result-box etc)
  function copyElementText(id) {
    const el = document.getElementById(id);
    if (!el) {
      alert("Bloco n√£o encontrado.");
      return;
    }
    const text = el.innerText || el.textContent || "";
    if (!text.trim()) {
      alert("Nada para copiar ainda. Rode a an√°lise primeiro. ‚ö°");
      return;
    }
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text).then(() => {
        alert("Texto copiado! Cole onde quiser (IA, notas, etc). üìã");
      }).catch(err => {
        console.warn("Erro ao copiar:", err);
        fallbackSelectText(el);
      });
    } else {
      fallbackSelectText(el);
    }
  }

  // ---------------- GEOLOCALIZA√á√ÉO (ON DEMAND) ----------------
  function askLocationOnce() {
    if (!("geolocation" in navigator)) {
      const box = document.getElementById("solarAutoBox");
      if (box) {
        box.style.display = "block";
        box.textContent = "Seu navegador n√£o suporta localiza√ß√£o autom√°tica. Voc√™ pode usar os campos normalmente.";
      }
      return;
    }

    navigator.geolocation.getCurrentPosition(
      position => {
        lastLocation = {
          lat: position.coords.latitude,
          lon: position.coords.longitude,
          accuracy: position.coords.accuracy
        };
        log("Localiza√ß√£o capturada:", lastLocation);
        updateSolarFromLocation(lastLocation);
      },
      err => {
        console.warn("Usu√°rio n√£o permitiu localiza√ß√£o ou falhou:", err);
        const box = document.getElementById("solarAutoBox");
        if (box) {
          box.style.display = "block";
          box.textContent = "N√£o consegui pegar sua localiza√ß√£o agora. Voc√™ ainda pode preencher os valores manualmente.";
        }
      },
      { enableHighAccuracy: false, timeout: 8000, maximumAge: 60000 }
    );
  }

  function estimateSolarByLat(latAbs) {
    if (latAbs < 10) {
      return { classe: "muito alto", solHorasDia: 5.5, kwhAnoPorKwp: 1900 };
    } else if (latAbs < 20) {
      return { classe: "alto", solHorasDia: 5.0, kwhAnoPorKwp: 1750 };
    } else if (latAbs < 30) {
      return { classe: "bom", solHorasDia: 4.5, kwhAnoPorKwp: 1600 };
    } else if (latAbs < 40) {
      return { classe: "moderado", solHorasDia: 4.0, kwhAnoPorKwp: 1450 };
    } else {
      return { classe: "baixo", solHorasDia: 3.5, kwhAnoPorKwp: 1300 };
    }
  }

  function updateSolarFromLocation(loc) {
    const box = document.getElementById("solarAutoBox");
    if (!box) return;

    const lat = loc.lat;
    const lon = loc.lon;
    const latAbs = Math.abs(lat);

    const est = estimateSolarByLat(latAbs);
    const kwhAnoPorKwp = est.kwhAnoPorKwp;
    const kwhMesPorKwp = kwhAnoPorKwp / 12;

    const tarifaKwh = 0.9;
    const economiaMensal1Kwp = kwhMesPorKwp * tarifaKwh;
    const economiaAnual1Kwp = kwhAnoPorKwp * tarifaKwh;

    const kwhServidorMes = kwhMesPorKwp * 0.25;
    const servidores1Kwp = Math.floor(kwhServidorMes / 72);

    const fotosPorServidor = 40000;
    const horasStreamingPorServidorMes = 200;
    const conexoesSimultaneasPorServidor = 40;

    const fotos1Kwp = servidores1Kwp * fotosPorServidor;
    const horasVideo1Kwp = servidores1Kwp * horasStreamingPorServidorMes;
    const conexoes1Kwp = servidores1Kwp * conexoesSimultaneasPorServidor;

    const sistema3KwpEconomiaMensal = economiaMensal1Kwp * 3;
    const sistema3KwpEconomiaAnual = economiaAnual1Kwp * 3;

    if (!localDetectadoCriado) {
      let gastoInicial = economiaMensal1Kwp * 2;
      if (gastoInicial < 150) gastoInicial = 150;
      if (gastoInicial > 450) gastoInicial = 450;

      addLocal("Local detectado (geo)", gastoInicial.toFixed(0));
      localDetectadoCriado = true;

      const cidadeInput = document.getElementById("perfilCidade");
      if (cidadeInput && !cidadeInput.value) {
        cidadeInput.value = `Bairro solar (lat ${lat.toFixed(2)}, lon ${lon.toFixed(2)})`;
      }
    }

    box.style.display = "block";
    box.innerHTML =
`<details open>
  <summary>Resumo r√°pido da sua regi√£o solar</summary>
  <div class="tiny" style="margin-top:4px;">
    <strong>Latitude aproximada:</strong> ${lat.toFixed(3)}¬∞ ¬∑ <strong>Longitude:</strong> ${lon.toFixed(3)}¬∞<br>
    Classe solar: <strong>${est.classe.toUpperCase()}</strong><br>
    Sol pleno m√©dio: <strong>${est.solHorasDia.toFixed(1)} h/dia</strong><br><br>
    1 kWp na sua regi√£o gera ‚âà <strong>${kwhAnoPorKwp.toFixed(0)} kWh/ano</strong>  
    (‚âà ${kwhMesPorKwp.toFixed(0)} kWh/m√™s)<br>
    Economia simb√≥lica: ‚âà <strong>R$ ${economiaMensal1Kwp.toFixed(0)}/m√™s</strong> por 1 kWp
  </div>
</details>

<details style="margin-top:6px;">
  <summary>Ver detalhes t√©cnicos & servidores solares</summary>
  <div class="tiny" style="margin-top:4px;">
    Exemplo de sistema de <strong>3 kWp</strong>:<br>
    ‚Ä¢ Economia ‚âà <strong>R$ ${sistema3KwpEconomiaMensal.toFixed(0)}/m√™s</strong><br>
    ‚Ä¢ Economia ‚âà <strong>R$ ${sistema3KwpEconomiaAnual.toFixed(0)}/ano</strong><br><br>

    Reservando ~25% da energia de 1 kWp s√≥ para servidores solares:<br>
    ‚Ä¢ Mini-servidores de 100W 24/7 ‚âà <strong>${servidores1Kwp}</strong> n√≥s<br>
    ‚Ä¢ Armazenamento ‚âà <strong>${fotos1Kwp.toLocaleString("pt-BR")}</strong> fotos (5MB)<br>
    ‚Ä¢ Streaming local ‚âà <strong>${horasVideo1Kwp.toLocaleString("pt-BR")}</strong> h de v√≠deo/m√™s<br>
    ‚Ä¢ Conex√µes simult√¢neas ‚âà <strong>${conexoes1Kwp.toLocaleString("pt-BR")}</strong> sess√µes<br><br>

    Isso √© a base para:<br>
    ‚Ä¢ Storage de fotos e v√≠deos do bairro sem depender s√≥ de nuvem externa<br>
    ‚Ä¢ Servidores de chat/Infodose rodando no pr√≥prio territ√≥rio<br>
    ‚Ä¢ Conex√µes mais r√°pidas e com mais sentido comunit√°rio.
  </div>
</details>`;
  }

  // ---------------- COMPARTILHAR / SHARE ----------------
  function shareNoSolar() {
    const raw = localStorage.getItem(PROFILE_KEY) || "{}";
    let profile;
    try { profile = JSON.parse(raw); } catch { profile = {}; }

    const nome = profile.nome || "Algu√©m";
    const cidade = profile.cidade || "meu bairro";
    const assistente = profile.assistente || "N√ìS.S¬∞LAR";

    const text = `${nome} est√° ativando o N√≥ Solar em ${cidade} com o assistente ${assistente}.  
Rede de lares conectados por energia solar, mini-servidores e cuidado com a casa.  
Vamos conectar seu lar tamb√©m?`;

    const url = location.href;

    if (navigator.share) {
      navigator.share({ title: "N√ìS.S¬∞LAR ¬∑ Nosso Lar", text, url })
        .catch(err => console.warn("Share cancelado/erro:", err));
    } else if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text + "\n\n" + url)
        .then(() => alert("Texto de convite copiado! Cole no WhatsApp, Instagram, etc. ‚ö°"))
        .catch(err => {
          console.warn("Erro ao copiar convite:", err);
          alert("N√£o consegui copiar, mas voc√™ pode selecionar manualmente.");
        });
    } else {
      alert("Seu navegador n√£o suporta compartilhamento direto, mas voc√™ pode copiar o link da barra.");
    }
  }

  // ---------------- START ----------------
  window.addEventListener("load", initApp);
  </script>
</body>
</html>